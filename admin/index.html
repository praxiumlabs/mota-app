<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOTA Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #D4AF37;
      --primary-dark: #B8860B;
      --bg-dark: #0a0a0a;
      --bg-card: #1a1a2e;
      --bg-input: #2a2a3e;
      --text-white: #ffffff;
      --text-gray: #888888;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #f44336;
      --gold: linear-gradient(135deg, #D4AF37, #B8860B);
      --platinum: linear-gradient(135deg, #E5E4E2, #C9C9C9);
      --diamond: linear-gradient(135deg, #B9F2FF, #E0FFFF);
      --black-tier: linear-gradient(135deg, #000000, #333333);
      --founders: linear-gradient(135deg, #FFD700, #FFA500);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-white);
      min-height: 100vh;
    }

    /* Login Screen */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: var(--bg-card);
      padding: 40px;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-logo {
      font-size: 48px;
      font-weight: bold;
      color: var(--primary);
      letter-spacing: 8px;
      margin-bottom: 10px;
    }

    .login-subtitle {
      color: var(--text-gray);
      margin-bottom: 30px;
    }

    .login-form input {
      width: 100%;
      padding: 15px;
      background: var(--bg-input);
      border: 1px solid transparent;
      border-radius: 10px;
      color: var(--text-white);
      margin-bottom: 15px;
      font-size: 16px;
    }

    .login-form input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: var(--gold);
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-btn:hover {
      transform: scale(1.02);
    }

    .login-error {
      color: var(--danger);
      margin-top: 15px;
      display: none;
    }

    /* Dashboard Layout */
    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: flex;
    }

    .sidebar {
      width: 250px;
      background: var(--bg-card);
      min-height: 100vh;
      padding: 20px;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
    }

    .sidebar-logo {
      font-size: 28px;
      font-weight: bold;
      color: var(--primary);
      letter-spacing: 5px;
      margin-bottom: 5px;
    }

    .sidebar-subtitle {
      color: var(--text-gray);
      font-size: 12px;
      margin-bottom: 30px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: var(--text-gray);
      text-decoration: none;
      border-radius: 10px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(212, 175, 55, 0.1);
      color: var(--primary);
    }

    .nav-item i {
      width: 24px;
      margin-right: 12px;
    }

    .main-content {
      flex: 1;
      margin-left: 250px;
      padding: 30px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--gold);
      color: var(--bg-dark);
    }

    .btn-primary:hover {
      transform: scale(1.02);
    }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text-white);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 12px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gold);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      color: var(--text-gray);
      margin-top: 5px;
    }

    .stat-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 40px;
      opacity: 0.2;
      color: var(--primary);
    }

    /* Tables */
    .table-container {
      background: var(--bg-card);
      border-radius: 15px;
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: var(--bg-input);
      padding: 10px 15px;
      border-radius: 10px;
    }

    .search-box input {
      background: none;
      border: none;
      color: var(--text-white);
      margin-left: 10px;
      width: 200px;
    }

    .search-box input:focus {
      outline: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 15px 20px;
      text-align: left;
    }

    th {
      background: rgba(0,0,0,0.2);
      color: var(--text-gray);
      font-weight: 500;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    tr {
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    tr:hover {
      background: rgba(212, 175, 55, 0.05);
    }

    .item-image {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      object-fit: cover;
    }

    .tier-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .tier-member { background: var(--bg-input); color: var(--text-white); }
    .tier-gold { background: var(--gold); color: var(--bg-dark); }
    .tier-platinum { background: var(--platinum); color: var(--bg-dark); }
    .tier-diamond { background: var(--diamond); color: var(--bg-dark); }
    .tier-black { background: var(--black-tier); color: var(--text-white); }
    .tier-founders { background: var(--founders); color: var(--bg-dark); }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active { background: rgba(76, 175, 80, 0.2); color: var(--success); }
    .status-pending { background: rgba(255, 152, 0, 0.2); color: var(--warning); }
    .status-inactive { background: rgba(244, 67, 54, 0.2); color: var(--danger); }

    .actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      width: 35px;
      height: 35px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .action-btn.edit {
      background: rgba(212, 175, 55, 0.2);
      color: var(--primary);
    }

    .action-btn.delete {
      background: rgba(244, 67, 54, 0.2);
      color: var(--danger);
    }

    .action-btn:hover {
      transform: scale(1.1);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: var(--bg-input);
      border: none;
      color: var(--text-white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      color: var(--text-gray);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 15px;
      background: var(--bg-input);
      border: 1px solid transparent;
      border-radius: 10px;
      color: var(--text-white);
      font-size: 14px;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-select {
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 15px 25px;
      background: var(--success);
      color: white;
      border-radius: 10px;
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }

    .toast.active {
      display: flex;
    }

    .toast.error {
      background: var(--danger);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--bg-input);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .logout-btn {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
    }

    .price-calculator {
      background: var(--bg-input);
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 13px;
    }

    .price-row span:first-child {
      color: var(--text-gray);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-gray);
    }

    .empty-state i {
      font-size: 60px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">MOTA</div>
      <p class="login-subtitle">Admin Dashboard</p>
      <form class="login-form" id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" value="admin@mota.com" required>
        <input type="password" id="loginPassword" placeholder="Password" value="admin123" required>
        <button type="submit" class="login-btn">Sign In</button>
      </form>
      <p class="login-error" id="loginError">Invalid credentials</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">MOTA</div>
      <p class="sidebar-subtitle">Admin Dashboard</p>
      
      <nav>
        <a class="nav-item active" data-page="overview">
          <i class="fas fa-chart-line"></i> Overview
        </a>
        <a class="nav-item" data-page="restaurants">
          <i class="fas fa-utensils"></i> Restaurants
        </a>
        <a class="nav-item" data-page="activities">
          <i class="fas fa-hiking"></i> Activities
        </a>
        <a class="nav-item" data-page="events">
          <i class="fas fa-calendar-alt"></i> Events
        </a>
        <a class="nav-item" data-page="offers">
          <i class="fas fa-tags"></i> Offers
        </a>
        <a class="nav-item" data-page="users">
          <i class="fas fa-users"></i> Users
        </a>
        <a class="nav-item" data-page="bookings">
          <i class="fas fa-book"></i> Bookings
        </a>
      </nav>

      <button class="btn btn-secondary logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Overview Page -->
      <section class="page-section active" id="page-overview">
        <div class="page-header">
          <h1 class="page-title">Overview</h1>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="stat-users">0</div>
            <div class="stat-label">Total Users</div>
            <i class="fas fa-users stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-investors">0</div>
            <div class="stat-label">Investors</div>
            <i class="fas fa-gem stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-restaurants">0</div>
            <div class="stat-label">Restaurants</div>
            <i class="fas fa-utensils stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-activities">0</div>
            <div class="stat-label">Activities</div>
            <i class="fas fa-hiking stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-events">0</div>
            <div class="stat-label">Events</div>
            <i class="fas fa-calendar stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-bookings">0</div>
            <div class="stat-label">Bookings</div>
            <i class="fas fa-book stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-investment">$0</div>
            <div class="stat-label">Total Investment</div>
            <i class="fas fa-dollar-sign stat-icon"></i>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-offers">0</div>
            <div class="stat-label">Active Offers</div>
            <i class="fas fa-tags stat-icon"></i>
          </div>
        </div>

        <!-- Investor Breakdown -->
        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Investor Breakdown</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>Tier</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody id="investorBreakdown">
            </tbody>
          </table>
        </div>
      </section>

      <!-- Restaurants Page -->
      <section class="page-section" id="page-restaurants">
        <div class="page-header">
          <h1 class="page-title">Restaurants</h1>
          <button class="btn btn-primary" onclick="openModal('restaurant')">
            <i class="fas fa-plus"></i> Add Restaurant
          </button>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">All Restaurants</h3>
            <div class="search-box">
              <i class="fas fa-search" style="color: var(--text-gray)"></i>
              <input type="text" placeholder="Search restaurants..." id="searchRestaurants">
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Regular Price</th>
                <th>Member Price</th>
                <th>Rating</th>
                <th>Featured</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="restaurantsTable">
            </tbody>
          </table>
        </div>
      </section>

      <!-- Activities Page -->
      <section class="page-section" id="page-activities">
        <div class="page-header">
          <h1 class="page-title">Activities</h1>
          <button class="btn btn-primary" onclick="openModal('activity')">
            <i class="fas fa-plus"></i> Add Activity
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Duration</th>
                <th>Regular Price</th>
                <th>Rating</th>
                <th>Featured</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="activitiesTable">
            </tbody>
          </table>
        </div>
      </section>

      <!-- Events Page -->
      <section class="page-section" id="page-events">
        <div class="page-header">
          <h1 class="page-title">Events</h1>
          <button class="btn btn-primary" onclick="openModal('event')">
            <i class="fas fa-plus"></i> Add Event
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Date</th>
                <th>Venue</th>
                <th>Capacity</th>
                <th>VIP Only</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="eventsTable">
            </tbody>
          </table>
        </div>
      </section>

      <!-- Offers Page -->
      <section class="page-section" id="page-offers">
        <div class="page-header">
          <h1 class="page-title">Offers & Promotions</h1>
          <button class="btn btn-primary" onclick="openModal('offer')">
            <i class="fas fa-plus"></i> Add Offer
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Type</th>
                <th>Discount</th>
                <th>Code</th>
                <th>Min Tier</th>
                <th>Valid Until</th>
                <th>Uses</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="offersTable">
            </tbody>
          </table>
        </div>
      </section>

      <!-- Users Page -->
      <section class="page-section" id="page-users">
        <div class="page-header">
          <h1 class="page-title">Users</h1>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">All Users</h3>
            <div class="search-box">
              <i class="fas fa-search" style="color: var(--text-gray)"></i>
              <input type="text" placeholder="Search users..." id="searchUsers">
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Access Level</th>
                <th>Investor Tier</th>
                <th>Investment</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable">
            </tbody>
          </table>
        </div>
      </section>

      <!-- Bookings Page -->
      <section class="page-section" id="page-bookings">
        <div class="page-header">
          <h1 class="page-title">Bookings</h1>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Type</th>
                <th>Item</th>
                <th>Date</th>
                <th>Guests</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookingsTable">
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Add Item</h3>
        <button class="modal-close" onclick="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamic form content -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="modalSaveBtn" onclick="saveItem()">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Success!</span>
  </div>

  <script>
    // API Configuration
    const API_URL = 'http://localhost:3001/api';
    let token = localStorage.getItem('adminToken');
    let currentPage = 'overview';
    let currentModal = null;
    let editingId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (token) {
        showDashboard();
        loadAllData();
      }

      // Login form
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          navigateTo(page);
        });
      });

      // Search handlers
      document.getElementById('searchRestaurants')?.addEventListener('input', (e) => {
        filterTable('restaurantsTable', e.target.value);
      });
      document.getElementById('searchUsers')?.addEventListener('input', (e) => {
        filterTable('usersTable', e.target.value);
      });
    });

    // Auth Functions
    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const response = await fetch(`${API_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          token = data.token;
          localStorage.setItem('adminToken', token);
          showDashboard();
          loadAllData();
        } else {
          document.getElementById('loginError').style.display = 'block';
        }
      } catch (error) {
        console.error('Login error:', error);
        document.getElementById('loginError').textContent = 'Connection error. Is the server running?';
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function logout() {
      token = null;
      localStorage.removeItem('adminToken');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('active');
    }

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
    }

    // Navigation
    function navigateTo(page) {
      currentPage = page;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === `page-${page}`);
      });

      // Load data for page
      switch(page) {
        case 'overview': loadStats(); break;
        case 'restaurants': loadRestaurants(); break;
        case 'activities': loadActivities(); break;
        case 'events': loadEvents(); break;
        case 'offers': loadOffers(); break;
        case 'users': loadUsers(); break;
        case 'bookings': loadBookings(); break;
      }
    }

    // API Functions
    async function apiRequest(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      const response = await fetch(`${API_URL}${endpoint}`, options);
      return response.json();
    }

    // Load All Data
    async function loadAllData() {
      loadStats();
    }

    // Load Stats
    async function loadStats() {
      try {
        const stats = await apiRequest('/admin/stats');
        
        document.getElementById('stat-users').textContent = stats.totalUsers || 0;
        document.getElementById('stat-investors').textContent = stats.totalInvestors || 0;
        document.getElementById('stat-restaurants').textContent = stats.totalRestaurants || 0;
        document.getElementById('stat-activities').textContent = stats.totalActivities || 0;
        document.getElementById('stat-events').textContent = stats.totalEvents || 0;
        document.getElementById('stat-bookings').textContent = stats.totalBookings || 0;
        document.getElementById('stat-investment').textContent = `$${(stats.totalInvestment || 0).toLocaleString()}`;
        document.getElementById('stat-offers').textContent = stats.activeOffers || 0;

        // Investor breakdown
        const breakdown = stats.investorsByTier || {};
        const breakdownHtml = Object.entries(breakdown).map(([tier, count]) => `
          <tr>
            <td><span class="tier-badge tier-${tier}">${tier.charAt(0).toUpperCase() + tier.slice(1)}</span></td>
            <td>${count}</td>
          </tr>
        `).join('');
        document.getElementById('investorBreakdown').innerHTML = breakdownHtml || '<tr><td colspan="2">No investors yet</td></tr>';
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load Restaurants
    async function loadRestaurants() {
      try {
        const restaurants = await apiRequest('/restaurants');
        const html = restaurants.map(r => `
          <tr>
            <td><img src="${r.image}" class="item-image" onerror="this.src='https://via.placeholder.com/50'"></td>
            <td><strong>${r.name}</strong></td>
            <td>${r.category}</td>
            <td>$${r.regularPrice}</td>
            <td>$${r.memberPrice || '-'}</td>
            <td><i class="fas fa-star" style="color: var(--primary)"></i> ${r.rating}</td>
            <td>${r.isFeatured ? '<i class="fas fa-check" style="color: var(--success)"></i>' : ''}</td>
            <td class="actions">
              <button class="action-btn edit" onclick="editItem('restaurant', '${r._id}')"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" onclick="deleteItem('restaurant', '${r._id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        document.getElementById('restaurantsTable').innerHTML = html || '<tr><td colspan="8" class="empty-state">No restaurants found</td></tr>';
      } catch (error) {
        console.error('Error loading restaurants:', error);
      }
    }

    // Load Activities
    async function loadActivities() {
      try {
        const activities = await apiRequest('/activities');
        const html = activities.map(a => `
          <tr>
            <td><img src="${a.image}" class="item-image" onerror="this.src='https://via.placeholder.com/50'"></td>
            <td><strong>${a.name}</strong></td>
            <td>${a.category}</td>
            <td>${a.duration || '-'}</td>
            <td>$${a.regularPrice}</td>
            <td><i class="fas fa-star" style="color: var(--primary)"></i> ${a.rating}</td>
            <td>${a.isFeatured ? '<i class="fas fa-check" style="color: var(--success)"></i>' : ''}</td>
            <td class="actions">
              <button class="action-btn edit" onclick="editItem('activity', '${a._id}')"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" onclick="deleteItem('activity', '${a._id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        document.getElementById('activitiesTable').innerHTML = html || '<tr><td colspan="8" class="empty-state">No activities found</td></tr>';
      } catch (error) {
        console.error('Error loading activities:', error);
      }
    }

    // Load Events
    async function loadEvents() {
      try {
        const events = await apiRequest('/events');
        const html = events.map(e => `
          <tr>
            <td><img src="${e.image}" class="item-image" onerror="this.src='https://via.placeholder.com/50'"></td>
            <td><strong>${e.name}</strong></td>
            <td>${new Date(e.date).toLocaleDateString()}</td>
            <td>${e.venue || '-'}</td>
            <td>${e.capacity || 'Unlimited'}</td>
            <td>${e.isVipOnly ? '<span class="tier-badge tier-gold">VIP Only</span>' : 'Public'}</td>
            <td class="actions">
              <button class="action-btn edit" onclick="editItem('event', '${e._id}')"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" onclick="deleteItem('event', '${e._id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        document.getElementById('eventsTable').innerHTML = html || '<tr><td colspan="7" class="empty-state">No events found</td></tr>';
      } catch (error) {
        console.error('Error loading events:', error);
      }
    }

    // Load Offers
    async function loadOffers() {
      try {
        const offers = await apiRequest('/offers');
        const html = offers.map(o => `
          <tr>
            <td><strong>${o.title}</strong></td>
            <td>${o.type}</td>
            <td>${o.discountPercent ? `${o.discountPercent}%` : o.freeAddon || '-'}</td>
            <td><code>${o.code || '-'}</code></td>
            <td><span class="tier-badge tier-${o.minTier || 'member'}">${(o.minTier || 'member').charAt(0).toUpperCase() + (o.minTier || 'member').slice(1)}</span></td>
            <td>${o.validUntil ? new Date(o.validUntil).toLocaleDateString() : '-'}</td>
            <td>${o.usedCount || 0}/${o.maxUses || 'âˆž'}</td>
            <td class="actions">
              <button class="action-btn edit" onclick="editItem('offer', '${o._id}')"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" onclick="deleteItem('offer', '${o._id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        document.getElementById('offersTable').innerHTML = html || '<tr><td colspan="8" class="empty-state">No offers found</td></tr>';
      } catch (error) {
        console.error('Error loading offers:', error);
      }
    }

    // Load Users
    async function loadUsers() {
      try {
        const data = await apiRequest('/admin/users');
        const users = data.users || [];
        const html = users.map(u => `
          <tr>
            <td><strong>${u.name}</strong></td>
            <td>${u.email}</td>
            <td><span class="tier-badge tier-${u.accessLevel === 'investor' ? 'gold' : 'member'}">${u.accessLevel}</span></td>
            <td>${u.investorTier ? `<span class="tier-badge tier-${u.investorTier}">${u.investorTier}</span>` : '-'}</td>
            <td>${u.investmentAmount ? `$${u.investmentAmount.toLocaleString()}` : '-'}</td>
            <td><span class="status-badge status-${u.isActive !== false ? 'active' : 'inactive'}">${u.isActive !== false ? 'Active' : 'Inactive'}</span></td>
            <td class="actions">
              <button class="action-btn edit" onclick="editUser('${u._id}')" title="Edit"><i class="fas fa-edit"></i></button>
              ${u.accessLevel !== 'investor' ? `<button class="btn btn-small btn-success" onclick="upgradeUser('${u._id}')" title="Upgrade to Investor"><i class="fas fa-arrow-up"></i></button>` : ''}
            </td>
          </tr>
        `).join('');
        document.getElementById('usersTable').innerHTML = html || '<tr><td colspan="7" class="empty-state">No users found</td></tr>';
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Load Bookings
    async function loadBookings() {
      try {
        const data = await apiRequest('/admin/bookings');
        const bookings = data.bookings || [];
        const html = bookings.map(b => `
          <tr>
            <td><strong>${b.userName || 'Unknown'}</strong><br><small>${b.userEmail || ''}</small></td>
            <td>${b.type}</td>
            <td>${b.itemName || '-'}</td>
            <td>${new Date(b.date).toLocaleDateString()}</td>
            <td>${b.guests || 1}</td>
            <td>$${b.totalPrice || 0}</td>
            <td><span class="status-badge status-${b.status}">${b.status}</span></td>
            <td class="actions">
              <button class="action-btn edit" onclick="updateBookingStatus('${b._id}', 'confirmed')"><i class="fas fa-check"></i></button>
              <button class="action-btn delete" onclick="updateBookingStatus('${b._id}', 'cancelled')"><i class="fas fa-times"></i></button>
            </td>
          </tr>
        `).join('');
        document.getElementById('bookingsTable').innerHTML = html || '<tr><td colspan="8" class="empty-state">No bookings found</td></tr>';
      } catch (error) {
        console.error('Error loading bookings:', error);
      }
    }

    // Modal Functions
    function openModal(type, data = null) {
      currentModal = type;
      editingId = data?._id || null;
      
      document.getElementById('modalTitle').textContent = `${editingId ? 'Edit' : 'Add'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
      document.getElementById('modalBody').innerHTML = getFormHtml(type, data);
      document.getElementById('modalOverlay').classList.add('active');

      // Add price calculator listener
      const priceInput = document.getElementById('regularPrice');
      if (priceInput) {
        priceInput.addEventListener('input', updatePriceCalculator);
        if (data?.regularPrice) updatePriceCalculator();
      }
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      currentModal = null;
      editingId = null;
    }

    function getFormHtml(type, data = null) {
      switch(type) {
        case 'restaurant':
          return `
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="name" value="${data?.name || ''}" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Category *</label>
                <input type="text" class="form-input" id="category" value="${data?.category || ''}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Price Range</label>
                <select class="form-select" id="priceRange">
                  <option value="$" ${data?.priceRange === '$' ? 'selected' : ''}>$ - Budget</option>
                  <option value="$$" ${data?.priceRange === '$$' || !data ? 'selected' : ''}>$$ - Moderate</option>
                  <option value="$$$" ${data?.priceRange === '$$$' ? 'selected' : ''}>$$$ - Upscale</option>
                  <option value="$$$$" ${data?.priceRange === '$$$$' ? 'selected' : ''}>$$$$ - Fine Dining</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-textarea" id="description">${data?.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-input" id="image" value="${data?.image || ''}" placeholder="https://...">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Regular Price ($) *</label>
                <input type="number" class="form-input" id="regularPrice" value="${data?.regularPrice || ''}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Rating</label>
                <input type="number" class="form-input" id="rating" value="${data?.rating || '4.5'}" step="0.1" min="1" max="5">
              </div>
            </div>
            <div class="price-calculator" id="priceCalculator">
              <strong>Auto-calculated tier prices:</strong>
              <div class="price-row"><span>Member (10% off):</span> <span id="calcMember">$0</span></div>
              <div class="price-row"><span>Platinum (15% off):</span> <span id="calcPlatinum">$0</span></div>
              <div class="price-row"><span>Diamond (25% off):</span> <span id="calcDiamond">$0</span></div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Open Hours</label>
                <input type="text" class="form-input" id="openHours" value="${data?.openHours || ''}" placeholder="6:00 PM - 11:00 PM">
              </div>
              <div class="form-group">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="location" value="${data?.location || ''}">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="isFeatured" ${data?.isFeatured ? 'checked' : ''}> Featured Restaurant
              </label>
            </div>
          `;
        
        case 'activity':
          return `
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="name" value="${data?.name || ''}" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Category *</label>
                <input type="text" class="form-input" id="category" value="${data?.category || ''}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Duration</label>
                <input type="text" class="form-input" id="duration" value="${data?.duration || ''}" placeholder="3 hours">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-textarea" id="description">${data?.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-input" id="image" value="${data?.image || ''}">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Regular Price ($) *</label>
                <input type="number" class="form-input" id="regularPrice" value="${data?.regularPrice || ''}" required>
              </div>
              <div class="form-group">
                <label class="form-label">Rating</label>
                <input type="number" class="form-input" id="rating" value="${data?.rating || '4.5'}" step="0.1" min="1" max="5">
              </div>
            </div>
            <div class="price-calculator" id="priceCalculator">
              <strong>Auto-calculated tier prices:</strong>
              <div class="price-row"><span>Member (10% off):</span> <span id="calcMember">$0</span></div>
              <div class="price-row"><span>Platinum (15% off):</span> <span id="calcPlatinum">$0</span></div>
              <div class="price-row"><span>Diamond (25% off):</span> <span id="calcDiamond">$0</span></div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="isFeatured" ${data?.isFeatured ? 'checked' : ''}> Featured Activity
              </label>
            </div>
          `;

        case 'event':
          return `
            <div class="form-group">
              <label class="form-label">Event Name *</label>
              <input type="text" class="form-input" id="name" value="${data?.name || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-textarea" id="description">${data?.description || ''}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-input" id="image" value="${data?.image || ''}">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Start Date *</label>
                <input type="date" class="form-input" id="date" value="${data?.date?.split('T')[0] || ''}" required>
              </div>
              <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" class="form-input" id="endDate" value="${data?.endDate?.split('T')[0] || ''}">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Venue</label>
                <input type="text" class="form-input" id="venue" value="${data?.venue || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Capacity</label>
                <input type="number" class="form-input" id="capacity" value="${data?.capacity || ''}">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="isVipOnly" ${data?.isVipOnly ? 'checked' : ''} onchange="toggleTierSelect()"> VIP Only Event
              </label>
            </div>
            <div class="form-group" id="tierSelectGroup" style="display: ${data?.isVipOnly ? 'block' : 'none'}">
              <label class="form-label">Minimum Tier Required</label>
              <select class="form-select" id="investorTierRequired">
                <option value="gold" ${data?.investorTierRequired === 'gold' ? 'selected' : ''}>Gold</option>
                <option value="platinum" ${data?.investorTierRequired === 'platinum' ? 'selected' : ''}>Platinum</option>
                <option value="diamond" ${data?.investorTierRequired === 'diamond' ? 'selected' : ''}>Diamond</option>
                <option value="black" ${data?.investorTierRequired === 'black' ? 'selected' : ''}>Black</option>
                <option value="founders" ${data?.investorTierRequired === 'founders' ? 'selected' : ''}>Founders</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="isFeatured" ${data?.isFeatured ? 'checked' : ''}> Featured Event
              </label>
            </div>
          `;

        case 'offer':
          return `
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="title" value="${data?.title || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-textarea" id="description">${data?.description || ''}</textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Type *</label>
                <select class="form-select" id="type" required>
                  <option value="restaurant" ${data?.type === 'restaurant' ? 'selected' : ''}>Restaurant</option>
                  <option value="activity" ${data?.type === 'activity' ? 'selected' : ''}>Activity</option>
                  <option value="event" ${data?.type === 'event' ? 'selected' : ''}>Event</option>
                  <option value="general" ${data?.type === 'general' ? 'selected' : ''}>General</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Promo Code</label>
                <input type="text" class="form-input" id="code" value="${data?.code || ''}" style="text-transform: uppercase">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Discount %</label>
                <input type="number" class="form-input" id="discountPercent" value="${data?.discountPercent || ''}" min="0" max="100">
              </div>
              <div class="form-group">
                <label class="form-label">OR Free Addon</label>
                <input type="text" class="form-input" id="freeAddon" value="${data?.freeAddon || ''}" placeholder="e.g., Spa Treatment">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Valid From</label>
                <input type="date" class="form-input" id="validFrom" value="${data?.validFrom?.split('T')[0] || ''}">
              </div>
              <div class="form-group">
                <label class="form-label">Valid Until</label>
                <input type="date" class="form-input" id="validUntil" value="${data?.validUntil?.split('T')[0] || ''}">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Minimum Tier</label>
                <select class="form-select" id="minTier">
                  <option value="member" ${data?.minTier === 'member' ? 'selected' : ''}>Member</option>
                  <option value="gold" ${data?.minTier === 'gold' ? 'selected' : ''}>Gold</option>
                  <option value="platinum" ${data?.minTier === 'platinum' ? 'selected' : ''}>Platinum</option>
                  <option value="diamond" ${data?.minTier === 'diamond' ? 'selected' : ''}>Diamond</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Max Uses</label>
                <input type="number" class="form-input" id="maxUses" value="${data?.maxUses || 100}">
              </div>
            </div>
          `;

        case 'user':
          return `
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" id="name" value="${data?.name || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="email" value="${data?.email || ''}" readonly>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Access Level</label>
                <select class="form-select" id="accessLevel">
                  <option value="member" ${data?.accessLevel === 'member' ? 'selected' : ''}>Member</option>
                  <option value="investor" ${data?.accessLevel === 'investor' ? 'selected' : ''}>Investor</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Investor Tier</label>
                <select class="form-select" id="investorTier">
                  <option value="">None</option>
                  <option value="gold" ${data?.investorTier === 'gold' ? 'selected' : ''}>Gold</option>
                  <option value="platinum" ${data?.investorTier === 'platinum' ? 'selected' : ''}>Platinum</option>
                  <option value="diamond" ${data?.investorTier === 'diamond' ? 'selected' : ''}>Diamond</option>
                  <option value="black" ${data?.investorTier === 'black' ? 'selected' : ''}>Black</option>
                  <option value="founders" ${data?.investorTier === 'founders' ? 'selected' : ''}>Founders</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Investment Amount ($)</label>
                <input type="number" class="form-input" id="investmentAmount" value="${data?.investmentAmount || 0}">
              </div>
              <div class="form-group">
                <label class="form-label">Portfolio Value ($)</label>
                <input type="number" class="form-input" id="portfolioValue" value="${data?.portfolioValue || 0}">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="isActive" ${data?.isActive !== false ? 'checked' : ''}> Active User
              </label>
            </div>
          `;

        case 'upgrade':
          return `
            <p style="margin-bottom: 20px; color: var(--text-gray)">Upgrade this user to an investor with a specific tier.</p>
            <div class="form-group">
              <label class="form-label">Investor Tier *</label>
              <select class="form-select" id="investorTier" required>
                <option value="gold">Gold ($0 - $249,999)</option>
                <option value="platinum">Platinum ($250,000 - $499,999)</option>
                <option value="diamond">Diamond ($500,000 - $999,999)</option>
                <option value="black">Black ($1,000,000+)</option>
                <option value="founders">Founders (Original Investors)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Investment Amount ($) *</label>
              <input type="number" class="form-input" id="investmentAmount" required placeholder="Enter investment amount">
            </div>
          `;

        default:
          return '<p>Unknown form type</p>';
      }
    }

    function toggleTierSelect() {
      const checkbox = document.getElementById('isVipOnly');
      const tierGroup = document.getElementById('tierSelectGroup');
      tierGroup.style.display = checkbox.checked ? 'block' : 'none';
    }

    function updatePriceCalculator() {
      const price = parseFloat(document.getElementById('regularPrice').value) || 0;
      document.getElementById('calcMember').textContent = `$${Math.round(price * 0.9)}`;
      document.getElementById('calcPlatinum').textContent = `$${Math.round(price * 0.85)}`;
      document.getElementById('calcDiamond').textContent = `$${Math.round(price * 0.75)}`;
    }

    // Save Item
    async function saveItem() {
      try {
        let endpoint, body;

        switch(currentModal) {
          case 'restaurant':
            body = {
              name: document.getElementById('name').value,
              category: document.getElementById('category').value,
              description: document.getElementById('description').value,
              image: document.getElementById('image').value,
              regularPrice: parseFloat(document.getElementById('regularPrice').value),
              rating: parseFloat(document.getElementById('rating').value),
              priceRange: document.getElementById('priceRange').value,
              openHours: document.getElementById('openHours').value,
              location: document.getElementById('location').value,
              isFeatured: document.getElementById('isFeatured').checked
            };
            endpoint = editingId ? `/admin/restaurants/${editingId}` : '/admin/restaurants';
            break;

          case 'activity':
            body = {
              name: document.getElementById('name').value,
              category: document.getElementById('category').value,
              description: document.getElementById('description').value,
              image: document.getElementById('image').value,
              regularPrice: parseFloat(document.getElementById('regularPrice').value),
              rating: parseFloat(document.getElementById('rating').value),
              duration: document.getElementById('duration').value,
              isFeatured: document.getElementById('isFeatured').checked
            };
            endpoint = editingId ? `/admin/activities/${editingId}` : '/admin/activities';
            break;

          case 'event':
            body = {
              name: document.getElementById('name').value,
              description: document.getElementById('description').value,
              image: document.getElementById('image').value,
              date: document.getElementById('date').value,
              endDate: document.getElementById('endDate').value,
              venue: document.getElementById('venue').value,
              capacity: parseInt(document.getElementById('capacity').value) || null,
              isVipOnly: document.getElementById('isVipOnly').checked,
              investorTierRequired: document.getElementById('isVipOnly').checked ? document.getElementById('investorTierRequired').value : null,
              isFeatured: document.getElementById('isFeatured').checked
            };
            endpoint = editingId ? `/admin/events/${editingId}` : '/admin/events';
            break;

          case 'offer':
            body = {
              title: document.getElementById('title').value,
              description: document.getElementById('description').value,
              type: document.getElementById('type').value,
              code: document.getElementById('code').value.toUpperCase(),
              discountPercent: parseInt(document.getElementById('discountPercent').value) || 0,
              freeAddon: document.getElementById('freeAddon').value,
              validFrom: document.getElementById('validFrom').value,
              validUntil: document.getElementById('validUntil').value,
              minTier: document.getElementById('minTier').value,
              maxUses: parseInt(document.getElementById('maxUses').value) || 100
            };
            endpoint = editingId ? `/admin/offers/${editingId}` : '/admin/offers';
            break;

          case 'user':
            body = {
              name: document.getElementById('name').value,
              accessLevel: document.getElementById('accessLevel').value,
              investorTier: document.getElementById('investorTier').value || null,
              investmentAmount: parseFloat(document.getElementById('investmentAmount').value) || 0,
              portfolioValue: parseFloat(document.getElementById('portfolioValue').value) || 0,
              isActive: document.getElementById('isActive').checked
            };
            endpoint = `/admin/users/${editingId}`;
            break;

          case 'upgrade':
            body = {
              investorTier: document.getElementById('investorTier').value,
              investmentAmount: parseFloat(document.getElementById('investmentAmount').value)
            };
            endpoint = `/admin/users/${editingId}/upgrade-to-investor`;
            await apiRequest(endpoint, 'POST', body);
            showToast('User upgraded to investor successfully!');
            closeModal();
            loadUsers();
            loadStats();
            return;
        }

        await apiRequest(endpoint, editingId ? 'PUT' : 'POST', body);
        showToast(`${currentModal} ${editingId ? 'updated' : 'created'} successfully!`);
        closeModal();
        
        // Reload current page data
        navigateTo(currentPage);
        loadStats();
      } catch (error) {
        console.error('Save error:', error);
        showToast('Error saving item', true);
      }
    }

    // Edit Item
    async function editItem(type, id) {
      try {
        let data;
        switch(type) {
          case 'restaurant':
            data = await apiRequest(`/restaurants/${id}`);
            break;
          case 'activity':
            data = await apiRequest(`/activities/${id}`);
            break;
          case 'event':
            data = await apiRequest(`/events/${id}`);
            break;
          case 'offer':
            data = await apiRequest(`/offers/${id}`);
            break;
        }
        openModal(type, data);
      } catch (error) {
        console.error('Error loading item:', error);
        showToast('Error loading item', true);
      }
    }

    // Edit User
    async function editUser(id) {
      try {
        const data = await apiRequest(`/admin/users/${id}`);
        openModal('user', data);
      } catch (error) {
        console.error('Error loading user:', error);
        showToast('Error loading user', true);
      }
    }

    // Upgrade User
    function upgradeUser(id) {
      editingId = id;
      openModal('upgrade');
    }

    // Delete Item
    async function deleteItem(type, id) {
      if (!confirm(`Are you sure you want to delete this ${type}?`)) return;

      try {
        await apiRequest(`/admin/${type}s/${id}`, 'DELETE');
        showToast(`${type} deleted successfully!`);
        navigateTo(currentPage);
        loadStats();
      } catch (error) {
        console.error('Delete error:', error);
        showToast('Error deleting item', true);
      }
    }

    // Update Booking Status
    async function updateBookingStatus(id, status) {
      try {
        await apiRequest(`/admin/bookings/${id}`, 'PUT', { status });
        showToast(`Booking ${status}!`);
        loadBookings();
      } catch (error) {
        console.error('Error updating booking:', error);
        showToast('Error updating booking', true);
      }
    }

    // Filter Table
    function filterTable(tableId, query) {
      const table = document.getElementById(tableId);
      const rows = table.getElementsByTagName('tr');
      const lowerQuery = query.toLowerCase();

      for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(lowerQuery) ? '' : 'none';
      }
    }

    // Toast
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.classList.toggle('error', isError);
      toast.classList.add('active');

      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }
  </script>
</body>
</html>
