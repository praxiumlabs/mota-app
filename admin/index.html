<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOTA Admin CMS</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg-primary:#0a0a0f; --bg-secondary:#12121a; --bg-tertiary:#1a1a25; --bg-card:#15151f; --border:#2a2a3a; --text-primary:#fff; --text-secondary:#a0a0b0; --text-muted:#606070; --accent:#c9a962; --accent-hover:#d4b872; --success:#4ade80; --warning:#fbbf24; --danger:#f87171; --info:#60a5fa; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; }
    
    .login-container { min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .login-box { background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:48px; width:100%; max-width:420px; }
    .login-logo { font-family:'Playfair Display',serif; font-size:32px; font-weight:700; color:var(--accent); text-align:center; margin-bottom:8px; letter-spacing:4px; }
    .login-subtitle { text-align:center; color:var(--text-secondary); margin-bottom:32px; font-size:14px; }
    
    .form-group { margin-bottom:20px; }
    .form-label { display:block; font-size:13px; font-weight:500; color:var(--text-secondary); margin-bottom:8px; }
    .form-input,.form-select,.form-textarea { width:100%; padding:12px 14px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:14px; transition:all 0.2s; }
    .form-input:focus,.form-select:focus,.form-textarea:focus { outline:none; border-color:var(--accent); }
    .form-textarea { min-height:100px; resize:vertical; font-family:inherit; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
    .form-error { background:rgba(248,113,113,0.1); border:1px solid rgba(248,113,113,0.3); color:var(--danger); padding:12px; border-radius:8px; margin-bottom:16px; font-size:14px; }
    .form-help { font-size:12px; color:var(--text-muted); margin-top:4px; }
    
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 20px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; border:none; }
    .btn-primary { background:var(--accent); color:var(--bg-primary); }
    .btn-primary:hover { background:var(--accent-hover); }
    .btn-secondary { background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border); }
    .btn-secondary:hover { border-color:var(--accent); }
    .btn-danger { background:rgba(248,113,113,0.1); color:var(--danger); border:1px solid rgba(248,113,113,0.3); }
    .btn-danger:hover { background:rgba(248,113,113,0.2); }
    .btn-success { background:rgba(74,222,128,0.1); color:var(--success); border:1px solid rgba(74,222,128,0.3); }
    .btn-sm { padding:8px 14px; font-size:13px; }
    .btn-block { width:100%; }
    
    .dashboard { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:var(--bg-secondary); border-right:1px solid var(--border); padding:24px 0; position:fixed; height:100vh; overflow-y:auto; }
    .sidebar-logo { font-family:'Playfair Display',serif; font-size:24px; font-weight:700; color:var(--accent); padding:0 24px; margin-bottom:4px; letter-spacing:3px; }
    .sidebar-subtitle { font-size:11px; color:var(--text-muted); padding:0 24px; margin-bottom:32px; text-transform:uppercase; letter-spacing:1px; }
    .nav-item { display:flex; align-items:center; gap:12px; padding:12px 24px; color:var(--text-secondary); cursor:pointer; transition:all 0.2s; font-size:14px; }
    .nav-item:hover { background:var(--bg-tertiary); color:var(--text-primary); }
    .nav-item.active { background:rgba(201,169,98,0.1); color:var(--accent); border-right:2px solid var(--accent); }
    .main-content { flex:1; margin-left:260px; padding:32px; }
    
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:32px; flex-wrap:wrap; gap:16px; }
    .page-title { font-family:'Playfair Display',serif; font-size:28px; font-weight:600; }
    .page-subtitle { color:var(--text-secondary); font-size:14px; margin-top:4px; }
    .page-actions { display:flex; gap:12px; }
    
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-bottom:32px; }
    .stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px; transition:all 0.2s; }
    .stat-card:hover { border-color:var(--accent); transform:translateY(-2px); }
    .stat-label { font-size:13px; color:var(--text-secondary); margin-bottom:8px; }
    .stat-value { font-size:28px; font-weight:700; }
    .stat-change { font-size:12px; margin-top:4px; }
    .stat-change.up { color:var(--success); }
    .stat-change.down { color:var(--danger); }
    
    .card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:24px; }
    .card-header { display:flex; justify-content:space-between; align-items:center; padding:20px 24px; border-bottom:1px solid var(--border); }
    .card-title { font-size:16px; font-weight:600; }
    .card-body { padding:24px; }
    
    .table-container { overflow-x:auto; }
    .table { width:100%; border-collapse:collapse; min-width:600px; }
    .table th { text-align:left; padding:14px 16px; font-size:11px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; background:var(--bg-tertiary); border-bottom:1px solid var(--border); white-space:nowrap; }
    .table td { padding:14px 16px; font-size:14px; border-bottom:1px solid var(--border); }
    .table tr:hover td { background:var(--bg-tertiary); }
    .table-img { width:50px; height:50px; border-radius:8px; object-fit:cover; background:var(--bg-tertiary); }
    
    .badge { display:inline-flex; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:600; text-transform:uppercase; }
    .badge-success { background:rgba(74,222,128,0.15); color:var(--success); }
    .badge-warning { background:rgba(251,191,36,0.15); color:var(--warning); }
    .badge-danger { background:rgba(248,113,113,0.15); color:var(--danger); }
    .badge-info { background:rgba(96,165,250,0.15); color:var(--info); }
    .badge-gold { background:rgba(201,169,98,0.15); color:var(--accent); }
    .badge-platinum { background:rgba(192,192,210,0.15); color:#c0c0d2; }
    .badge-diamond { background:rgba(185,242,255,0.15); color:#b9f2ff; }
    
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000; padding:20px; }
    .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:16px; width:100%; max-width:700px; max-height:90vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; padding:20px 24px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--bg-card); z-index:1; }
    .modal-title { font-size:18px; font-weight:600; }
    .modal-close { width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:var(--bg-tertiary); border:none; color:var(--text-secondary); cursor:pointer; font-size:20px; }
    .modal-close:hover { color:var(--text-primary); }
    .modal-body { padding:24px; }
    .modal-footer { display:flex; justify-content:flex-end; gap:12px; padding:20px 24px; border-top:1px solid var(--border); position:sticky; bottom:0; background:var(--bg-card); }
    
    .slide-list { display:flex; flex-direction:column; gap:12px; }
    .slide-item { display:flex; gap:16px; padding:16px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:12px; transition:all 0.2s; }
    .slide-item:hover { border-color:var(--accent); }
    .slide-preview { width:140px; height:80px; border-radius:8px; object-fit:cover; background:var(--bg-tertiary); flex-shrink:0; }
    .slide-info { flex:1; min-width:0; }
    .slide-title { font-weight:600; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .slide-subtitle { font-size:13px; color:var(--text-secondary); margin-bottom:4px; }
    .slide-desc { font-size:12px; color:var(--text-muted); margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .slide-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    
    .toggle { display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .toggle-switch { width:44px; height:24px; background:var(--bg-tertiary); border-radius:12px; position:relative; transition:all 0.2s; flex-shrink:0; }
    .toggle-switch::after { content:''; position:absolute; width:18px; height:18px; background:var(--text-secondary); border-radius:50%; top:3px; left:3px; transition:all 0.2s; }
    .toggle.active .toggle-switch { background:var(--accent); }
    .toggle.active .toggle-switch::after { left:23px; background:var(--bg-primary); }
    .toggle-label { font-size:14px; }
    
    .avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--accent),#8b6914); display:flex; align-items:center; justify-content:center; font-weight:600; color:var(--bg-primary); flex-shrink:0; }
    .avatar-lg { width:64px; height:64px; font-size:24px; }
    .user-cell { display:flex; align-items:center; gap:12px; }
    .user-name { font-weight:500; }
    .user-email { font-size:12px; color:var(--text-muted); }
    
    .loading { display:flex; align-items:center; justify-content:center; padding:60px; color:var(--text-secondary); }
    .spinner { width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin-right:12px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    
    .empty { text-align:center; padding:60px 20px; color:var(--text-secondary); }
    .empty-icon { font-size:48px; margin-bottom:16px; opacity:0.5; }
    
    .alert { padding:16px; border-radius:8px; margin-bottom:20px; font-size:14px; }
    .alert-success { background:rgba(74,222,128,0.1); border:1px solid rgba(74,222,128,0.3); color:var(--success); }
    .alert-info { background:rgba(96,165,250,0.1); border:1px solid rgba(96,165,250,0.3); color:var(--info); }
    
    .divider { height:1px; background:var(--border); margin:24px 0; }
    
    .img-preview { width:100%; max-width:300px; height:150px; object-fit:cover; border-radius:8px; background:var(--bg-tertiary); margin-top:8px; }
    
    @media (max-width:768px) { .sidebar { display:none; } .main-content { margin-left:0; } .form-row,.form-row-3 { grid-template-columns:1fr; } }
    
    .hidden { display:none !important; }
    ::-webkit-scrollbar { width:8px; height:8px; }
    ::-webkit-scrollbar-track { background:var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover { background:var(--text-muted); }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    // =============================================
    // MOTA ADMIN CMS - FULL CONTROL
    // =============================================
    
    const API_BASE = 'https://unpromotable-manda-sprayfully.ngrok-free.dev/api';
    
    let state = {
      isLoggedIn: false,
      token: null,
      user: null,
      page: 'dashboard',
      data: {},
      loading: false,
      modal: null,
      alert: null
    };

    // =============================================
    // API HELPER
    // =============================================
    
    async function api(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true',
        ...(state.token ? { 'Authorization': `Bearer ${state.token}` } : {})
      };
      try {
        const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');
        return data;
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // =============================================
    // AUTH
    // =============================================
    
    async function login(email, password) {
      try {
        const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
        state.token = data.token;
        state.user = data.user;
        state.isLoggedIn = true;
        localStorage.setItem('mota_token', data.token);
        localStorage.setItem('mota_user', JSON.stringify(data.user));
        render();
        loadData();
      } catch (err) {
        return err.message;
      }
    }

    function logout() {
      state = { isLoggedIn: false, token: null, user: null, page: 'dashboard', data: {}, loading: false, modal: null, alert: null };
      localStorage.removeItem('mota_token');
      localStorage.removeItem('mota_user');
      render();
    }

    function checkAuth() {
      const token = localStorage.getItem('mota_token');
      const user = localStorage.getItem('mota_user');
      if (token && user) {
        state.token = token;
        state.user = JSON.parse(user);
        state.isLoggedIn = true;
      }
    }

    // =============================================
    // DATA
    // =============================================
    
    async function loadData() {
      state.loading = true;
      render();
      try {
        const [users, restaurants, events, lodging, activities, content, reservations, leads, nightlife, notifications, fleet] = await Promise.all([
          api('/users').catch(() => ({ users: [] })),
          api('/restaurants').catch(() => ({ restaurants: [] })),
          api('/events').catch(() => ({ events: [] })),
          api('/lodging').catch(() => ({ lodging: [] })),
          api('/activities').catch(() => ({ activities: [] })),
          api('/content').catch(() => ({ content: [] })),
          api('/reservations').catch(() => ({ reservations: [] })),
          api('/leads').catch(() => ({ leads: [] })),
          api('/nightlife').catch(() => ({ nightlife: [] })),
          api('/notifications').catch(() => ({ notifications: [] })),
          api('/fleet').catch(() => ({ fleet: [] }))
        ]);
        state.data = {
          users: users.users || [],
          restaurants: restaurants.restaurants || [],
          events: events.events || [],
          lodging: lodging.lodging || [],
          activities: activities.activities || [],
          content: content.content || [],
          reservations: reservations.reservations || reservations || [],
          leads: leads.leads || [],
          nightlife: nightlife.nightlife || [],
          notifications: notifications.notifications || [],
          fleet: fleet.fleet || []
        };
      } catch (err) {
        console.error('Load error:', err);
      }
      state.loading = false;
      render();
    }

    async function saveItem(type, id, data) {
      try {
        if (id) {
          await api(`/${type}/${id}`, { method: 'PUT', body: JSON.stringify(data) });
          showAlert('Updated successfully!', 'success');
        } else {
          await api(`/${type}`, { method: 'POST', body: JSON.stringify(data) });
          showAlert('Created successfully!', 'success');
        }
        closeModal();
        loadData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteItem(type, id, name) {
      if (!confirm(`Delete "${name || 'this item'}"? This cannot be undone.`)) return;
      try {
        await api(`/${type}/${id}`, { method: 'DELETE' });
        showAlert('Deleted successfully!', 'success');
        loadData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function saveContent(key, data) {
      try {
        await api(`/content/${key}`, { method: 'PUT', body: JSON.stringify(data) });
        showAlert('Content saved!', 'success');
        closeModal();
        loadData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // =============================================
    // UI HELPERS
    // =============================================
    
    function navigate(page) { state.page = page; state.alert = null; render(); }
    function openModal(type, data = null) { state.modal = { type, data }; render(); }
    function closeModal() { state.modal = null; render(); }
    function showAlert(msg, type = 'info') { state.alert = { msg, type }; render(); setTimeout(() => { state.alert = null; render(); }, 3000); }
    function esc(str) { return String(str || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }

    // =============================================
    // RENDER
    // =============================================
    
    function render() {
      document.getElementById('app').innerHTML = state.isLoggedIn ? renderDashboard() : renderLogin();
      attachEvents();
    }

    function renderLogin() {
      return `
        <div class="login-container">
          <div class="login-box">
            <div class="login-logo">MOTA</div>
            <div class="login-subtitle">Admin Content Management System</div>
            <div id="login-error" class="form-error hidden"></div>
            <form id="login-form">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="login-email" class="form-input" value="investor@demo.com" required>
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="login-password" class="form-input" value="demo123" required>
              </div>
              <button type="submit" class="btn btn-primary btn-block">Sign In to Admin</button>
            </form>
          </div>
        </div>
      `;
    }

    function renderDashboard() {
      return `
        <div class="dashboard">
          ${renderSidebar()}
          <main class="main-content">
            ${state.alert ? `<div class="alert alert-${state.alert.type}">${state.alert.msg}</div>` : ''}
            ${state.loading ? '<div class="loading"><div class="spinner"></div>Loading data...</div>' : renderPage()}
          </main>
          ${state.modal ? renderModal() : ''}
        </div>
      `;
    }

    function renderSidebar() {
      const nav = [
        { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
        { id: 'divider1' },
        { id: 'slideshow', icon: 'üñºÔ∏è', label: 'Homepage Slideshow' },
        { id: 'notifications', icon: 'üîî', label: 'Notifications' },
        { id: 'divider2' },
        { id: 'restaurants', icon: 'üçΩÔ∏è', label: 'Restaurants' },
        { id: 'events', icon: 'üéâ', label: 'Events' },
        { id: 'lodging', icon: 'üè†', label: 'Lodging' },
        { id: 'activities', icon: 'üèÑ', label: 'Activities' },
        { id: 'nightlife', icon: 'üåô', label: 'Nightlife' },
        { id: 'fleet', icon: 'üöó', label: 'PCH Exotic Fleet' },
        { id: 'divider3' },
        { id: 'users', icon: 'üë•', label: 'All Users' },
        { id: 'investors', icon: 'üíé', label: 'Investors' },
        { id: 'divider4' },
        { id: 'reservations', icon: 'üìÖ', label: 'Reservations' },
        { id: 'leads', icon: 'üìà', label: 'Leads CRM' },
        { id: 'divider5' },
        { id: 'settings', icon: '‚öôÔ∏è', label: 'App Settings' }
      ];
      return `
        <aside class="sidebar">
          <div class="sidebar-logo">MOTA</div>
          <div class="sidebar-subtitle">Content Management</div>
          <nav style="flex:1;">
            ${nav.map(n => n.id.startsWith('divider') ? '<div style="height:1px;background:var(--border);margin:12px 24px;"></div>' : `
              <div class="nav-item ${state.page === n.id ? 'active' : ''}" data-page="${n.id}">
                <span>${n.icon}</span><span>${n.label}</span>
              </div>
            `).join('')}
          </nav>
          <div style="padding:20px 24px;border-top:1px solid var(--border);">
            <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">Logged in as</div>
            <div style="font-weight:500;margin-bottom:12px;">${state.user?.name || state.user?.email}</div>
            <button class="btn btn-secondary btn-sm btn-block" id="logout-btn">Logout</button>
          </div>
        </aside>
      `;
    }

    function renderPage() {
      const pages = {
        dashboard: renderDashboardPage,
        slideshow: renderSlideshowPage,
        notifications: renderNotificationsPage,
        restaurants: () => renderCRUDPage('restaurants', 'Restaurant', ['name', 'cuisine', 'priceRange', 'rating', 'isFeatured']),
        events: () => renderCRUDPage('events', 'Event', ['name', 'date', 'venue', 'capacity', 'accessLevel']),
        lodging: () => renderCRUDPage('lodging', 'Property', ['name', 'type', 'price', 'bedrooms', 'isAvailable']),
        activities: () => renderCRUDPage('activities', 'Activity', ['name', 'category', 'price', 'duration', 'isFeatured']),
        nightlife: () => renderCRUDPage('nightlife', 'Venue', ['name', 'type', 'priceRange', 'hours', 'isFeatured']),
        fleet: renderFleetPage,
        users: renderUsersPage,
        investors: renderInvestorsPage,
        reservations: renderReservationsPage,
        leads: renderLeadsPage,
        settings: renderSettingsPage
      };
      return (pages[state.page] || pages.dashboard)();
    }

    // =============================================
    // DASHBOARD
    // =============================================

    function renderDashboardPage() {
      const d = state.data;
      const investors = (d.users || []).filter(u => u.accessLevel === 'investor');
      const totalInvestment = investors.reduce((sum, i) => sum + (i.investmentAmount || 0), 0);
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Welcome back, ${state.user?.name || 'Admin'}! Here's your overview.</p>
          </div>
          <button class="btn btn-secondary" onclick="loadData()">‚Üª Refresh Data</button>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card" onclick="navigate('users')" style="cursor:pointer">
            <div class="stat-label">Total Users</div>
            <div class="stat-value">${d.users?.length || 0}</div>
          </div>
          <div class="stat-card" onclick="navigate('investors')" style="cursor:pointer">
            <div class="stat-label">Investors</div>
            <div class="stat-value">${investors.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Investment</div>
            <div class="stat-value" style="font-size:22px;">$${(totalInvestment/1000000).toFixed(1)}M</div>
          </div>
          <div class="stat-card" onclick="navigate('restaurants')" style="cursor:pointer">
            <div class="stat-label">Restaurants</div>
            <div class="stat-value">${d.restaurants?.length || 0}</div>
          </div>
          <div class="stat-card" onclick="navigate('events')" style="cursor:pointer">
            <div class="stat-label">Events</div>
            <div class="stat-value">${d.events?.length || 0}</div>
          </div>
          <div class="stat-card" onclick="navigate('lodging')" style="cursor:pointer">
            <div class="stat-label">Lodging</div>
            <div class="stat-value">${d.lodging?.length || 0}</div>
          </div>
          <div class="stat-card" onclick="navigate('activities')" style="cursor:pointer">
            <div class="stat-label">Activities</div>
            <div class="stat-value">${d.activities?.length || 0}</div>
          </div>
          <div class="stat-card" onclick="navigate('reservations')" style="cursor:pointer">
            <div class="stat-label">Reservations</div>
            <div class="stat-value">${d.reservations?.length || 0}</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
          </div>
          <div class="card-body" style="display:flex;gap:12px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="navigate('slideshow')">üñºÔ∏è Edit Slideshow</button>
            <button class="btn btn-primary" onclick="openModal('sendNotification')">üîî Send Notification</button>
            <button class="btn btn-secondary" onclick="openModal('addRestaurant')">üçΩÔ∏è Add Restaurant</button>
            <button class="btn btn-secondary" onclick="openModal('addEvent')">üéâ Add Event</button>
            <button class="btn btn-secondary" onclick="openModal('addLodging')">üè† Add Property</button>
            <button class="btn btn-secondary" onclick="openModal('addActivity')">üèÑ Add Activity</button>
            <button class="btn btn-secondary" onclick="openModal('addCar')">üöó Add Car</button>
            <button class="btn btn-secondary" onclick="openModal('addYacht')">üõ•Ô∏è Add Yacht</button>
          </div>
        </div>
      `;
    }

    // =============================================
    // SLIDESHOW
    // =============================================

    function renderSlideshowPage() {
      const slideshow = state.data.content?.find(c => c.key === 'homepage_slideshow');
      const slides = (slideshow?.slides || []).sort((a, b) => (a.order || 0) - (b.order || 0));
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">Homepage Slideshow</h1>
            <p class="page-subtitle">Manage the hero slideshow that appears on the app homepage</p>
          </div>
          <button class="btn btn-primary" onclick="openModal('addSlide')">+ Add New Slide</button>
        </div>
        
        <div class="alert alert-info">
          <strong>üí° Tip:</strong> The slideshow displays on the mobile app's homepage. Use high-quality images (1200x600px recommended).
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Slides (${slides.length})</h3>
          </div>
          <div class="card-body">
            ${slides.length ? `
              <div class="slide-list">
                ${slides.map((s, i) => `
                  <div class="slide-item">
                    <img src="${esc(s.imageUrl)}" class="slide-preview" onerror="this.src='https://via.placeholder.com/140x80/1a1a25/606070?text=No+Image'">
                    <div class="slide-info">
                      <div class="slide-title">${esc(s.title) || 'Untitled Slide'}</div>
                      <div class="slide-subtitle">${esc(s.subtitle) || ''}</div>
                      <div class="slide-desc">${esc(s.description) || 'No description'}</div>
                      <div class="slide-actions">
                        <button class="btn btn-secondary btn-sm" onclick='editSlide(${i})'>‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSlide('${s._id}', '${esc(s.title)}')">üóëÔ∏è Delete</button>
                        <span class="badge ${s.isActive !== false ? 'badge-success' : 'badge-warning'}">${s.isActive !== false ? 'Active' : 'Hidden'}</span>
                        ${s.buttonText ? `<span class="badge badge-info">Button: ${esc(s.buttonText)}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div class="empty">
                <div class="empty-icon">üñºÔ∏è</div>
                <p>No slides yet. Add your first slide to get started!</p>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // =============================================
    // NOTIFICATIONS
    // =============================================

    function renderNotificationsPage() {
      const items = state.data.notifications || [];
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">Notifications</h1>
            <p class="page-subtitle">Send and manage push notifications to users</p>
          </div>
          <button class="btn btn-primary" onclick="openModal('sendNotification')">üîî Send Notification</button>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Sent</div>
            <div class="stat-value">${items.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">To All Users</div>
            <div class="stat-value">${items.filter(n => n.targetAudience === 'all').length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">To Investors</div>
            <div class="stat-value">${items.filter(n => n.targetAudience === 'investor').length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">System Alerts</div>
            <div class="stat-value">${items.filter(n => n.type === 'system').length}</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Notifications</h3>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Message</th>
                  <th>Type</th>
                  <th>Target</th>
                  <th>Sent</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${items.length ? items.map(n => `
                  <tr>
                    <td><strong>${esc(n.title)}</strong></td>
                    <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(n.message)}</td>
                    <td><span class="badge badge-${n.type === 'success' ? 'success' : n.type === 'warning' ? 'warning' : n.type === 'upgrade' ? 'gold' : 'info'}">${n.type || 'info'}</span></td>
                    <td><span class="badge badge-${n.targetAudience === 'investor' ? 'gold' : n.targetAudience === 'member' ? 'info' : 'success'}">${n.targetAudience || 'all'}</span></td>
                    <td>${new Date(n.createdAt).toLocaleDateString()}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteItem('notifications', '${n._id}', '${esc(n.title)}')">Delete</button></td>
                  </tr>
                `).join('') : '<tr><td colspan="6" class="empty">No notifications sent yet</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Quick Send</h3>
          </div>
          <div class="card-body">
            <div style="margin-bottom:16px;">
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">General</div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="quickNotification('promo')">üì£ Promo to All</button>
                <button class="btn btn-secondary" onclick="quickNotification('event')">üéâ Event Reminder</button>
                <button class="btn btn-secondary" onclick="quickNotification('system')">‚öôÔ∏è System Alert</button>
              </div>
            </div>
            <div>
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;">Investor Tiers</div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="quickNotification('investor')">üíé All Investors</button>
                <button class="btn btn-secondary" style="border-color:var(--accent);color:var(--accent);" onclick="quickNotification('gold')">ü•á Gold Only</button>
                <button class="btn btn-secondary" style="border-color:#c0c0d2;color:#c0c0d2;" onclick="quickNotification('platinum')">ü•à Platinum Only</button>
                <button class="btn btn-secondary" style="border-color:#b9f2ff;color:#b9f2ff;" onclick="quickNotification('diamond')">üíé Diamond Only</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // =============================================
    // PCH EXOTIC FLEET
    // =============================================

    function renderFleetPage() {
      const items = state.data.fleet || [];
      const cars = items.filter(i => i.type === 'car');
      const yachts = items.filter(i => i.type === 'yacht');
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">PCH Exotic Fleet</h1>
            <p class="page-subtitle">Manage luxury cars and yacht rentals</p>
          </div>
          <div class="page-actions">
            <button class="btn btn-secondary" onclick="openModal('addCar')">üöó Add Car</button>
            <button class="btn btn-primary" onclick="openModal('addYacht')">üõ•Ô∏è Add Yacht</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">üöó Exotic Cars</div>
            <div class="stat-value">${cars.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üõ•Ô∏è Yachts</div>
            <div class="stat-value">${yachts.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Available Now</div>
            <div class="stat-value">${items.filter(i => i.isAvailable).length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Featured</div>
            <div class="stat-value">${items.filter(i => i.isFeatured).length}</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üöó Exotic Cars (${cars.length})</h3>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr><th>Image</th><th>Vehicle</th><th>Specs</th><th>Daily Rate</th><th>Access</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                ${cars.length ? cars.map(c => `
                  <tr>
                    <td><img src="${c.images?.[0]?.url || ''}" class="table-img" onerror="this.src='https://via.placeholder.com/50/1a1a25/606070?text=üöó'"></td>
                    <td>
                      <strong>${esc(c.name)}</strong>
                      <br><small style="color:var(--text-muted)">${c.year || ''} ${esc(c.make || '')} ${esc(c.model || '')}</small>
                    </td>
                    <td>
                      <small>${c.specs?.horsepower || '-'}hp ‚Ä¢ ${c.specs?.acceleration || '-'} 0-60</small>
                    </td>
                    <td><strong>$${(c.pricePerDay || 0).toLocaleString()}</strong></td>
                    <td><span class="badge badge-${c.investorTierRequired === 'diamond' ? 'diamond' : c.investorTierRequired === 'platinum' ? 'platinum' : 'gold'}">${c.investorTierRequired || 'member'}</span></td>
                    <td><span class="badge ${c.isAvailable ? 'badge-success' : 'badge-danger'}">${c.isAvailable ? 'Available' : 'Booked'}</span></td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick='openEditModal("fleet", "${c._id}")'>Edit</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteItem('fleet', '${c._id}', '${esc(c.name)}')">Delete</button>
                    </td>
                  </tr>
                `).join('') : '<tr><td colspan="7" class="empty">No cars in fleet</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üõ•Ô∏è Yachts (${yachts.length})</h3>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr><th>Image</th><th>Yacht</th><th>Specs</th><th>Daily Rate</th><th>Access</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                ${yachts.length ? yachts.map(y => `
                  <tr>
                    <td><img src="${y.images?.[0]?.url || ''}" class="table-img" onerror="this.src='https://via.placeholder.com/50/1a1a25/606070?text=üõ•Ô∏è'"></td>
                    <td>
                      <strong>${esc(y.name)}</strong>
                      <br><small style="color:var(--text-muted)">${y.length || ''} ‚Ä¢ ${y.specs?.cabins || 0} cabins</small>
                    </td>
                    <td>
                      <small>${y.capacity || '-'} guests ‚Ä¢ ${y.specs?.crew || '-'} crew</small>
                    </td>
                    <td><strong>$${(y.pricePerDay || 0).toLocaleString()}</strong></td>
                    <td><span class="badge badge-${y.investorTierRequired === 'diamond' ? 'diamond' : y.investorTierRequired === 'platinum' ? 'platinum' : 'gold'}">${y.investorTierRequired || 'member'}</span></td>
                    <td><span class="badge ${y.isAvailable ? 'badge-success' : 'badge-danger'}">${y.isAvailable ? 'Available' : 'Booked'}</span></td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick='openEditModal("fleet", "${y._id}")'>Edit</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteItem('fleet', '${y._id}', '${esc(y.name)}')">Delete</button>
                    </td>
                  </tr>
                `).join('') : '<tr><td colspan="7" class="empty">No yachts in fleet</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // =============================================
    // GENERIC CRUD PAGE
    // =============================================

    function renderCRUDPage(type, singular, columns) {
      const items = state.data[type] || [];
      const typeMap = { restaurants: 'Restaurant', events: 'Event', lodging: 'Property', activities: 'Activity', nightlife: 'Venue' };
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">${singular}s</h1>
            <p class="page-subtitle">${items.length} ${singular.toLowerCase()}${items.length !== 1 ? 's' : ''} in the system</p>
          </div>
          <button class="btn btn-primary" onclick="openModal('add${typeMap[type]}')">+ Add ${singular}</button>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  ${columns.slice(1).map(c => `<th>${formatColName(c)}</th>`).join('')}
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${items.length ? items.map(item => `
                  <tr>
                    <td><img src="${item.images?.[0]?.url || ''}" class="table-img" onerror="this.src='https://via.placeholder.com/50/1a1a25/606070?text=?'"></td>
                    <td>
                      <strong>${esc(item.name || item.title)}</strong>
                      ${item.shortDescription ? `<br><small style="color:var(--text-muted)">${esc(item.shortDescription.substring(0, 50))}...</small>` : ''}
                    </td>
                    ${columns.slice(1).map(c => `<td>${formatValue(item, c)}</td>`).join('')}
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick='openEditModal("${type}", "${item._id}")'>Edit</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteItem('${type}', '${item._id}', '${esc(item.name || item.title)}')">Delete</button>
                    </td>
                  </tr>
                `).join('') : `<tr><td colspan="${columns.length + 2}" class="empty">No ${type} found</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function formatColName(col) {
      return col.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).replace('Is ', '').replace('Price Range', 'Price');
    }

    function formatValue(item, col) {
      const val = item[col];
      if (col === 'date' && val) return new Date(val).toLocaleDateString();
      if (col === 'price') return `$${val || item.pricePerNight || 0}`;
      if (col === 'rating') return val ? `‚≠ê ${val}` : '-';
      if (col === 'isFeatured') return val ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>';
      if (col === 'isAvailable') return val !== false ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-danger">No</span>';
      if (col === 'accessLevel') return `<span class="badge badge-info">${val || 'all'}</span>`;
      if (col === 'capacity') return val || '‚àû';
      return val || '-';
    }

    // =============================================
    // USERS
    // =============================================

    function renderUsersPage() {
      const items = state.data.users || [];
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">All Users</h1>
            <p class="page-subtitle">${items.length} registered users</p>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead><tr><th>User</th><th>Access Level</th><th>Investor Tier</th><th>Investment</th><th>Phone</th><th>Joined</th><th>Actions</th></tr></thead>
              <tbody>
                ${items.map(u => `
                  <tr>
                    <td>
                      <div class="user-cell">
                        <div class="avatar">${(u.name || u.email)?.[0]?.toUpperCase() || '?'}</div>
                        <div>
                          <div class="user-name">${esc(u.name) || 'No name'}</div>
                          <div class="user-email">${esc(u.email)}</div>
                        </div>
                      </div>
                    </td>
                    <td><span class="badge badge-${u.accessLevel === 'investor' ? 'gold' : u.accessLevel === 'member' ? 'info' : 'warning'}">${u.accessLevel || 'guest'}</span></td>
                    <td>${u.investorTier ? `<span class="badge badge-${u.investorTier}">${u.investorTier}</span>` : '-'}</td>
                    <td>${u.investmentAmount ? '$' + u.investmentAmount.toLocaleString() : '-'}</td>
                    <td>${esc(u.phone) || '-'}</td>
                    <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                    <td><button class="btn btn-primary btn-sm" onclick='openEditModal("users", "${u._id}")'>Edit User</button></td>
                  </tr>
                `).join('') || '<tr><td colspan="7" class="empty">No users found</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // =============================================
    // INVESTORS
    // =============================================

    function renderInvestorsPage() {
      const items = (state.data.users || []).filter(u => u.accessLevel === 'investor');
      const gold = items.filter(i => i.investorTier === 'gold');
      const platinum = items.filter(i => i.investorTier === 'platinum');
      const diamond = items.filter(i => i.investorTier === 'diamond');
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">Investors</h1>
            <p class="page-subtitle">${items.length} investors across all tiers</p>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ü•á Gold Tier ($2.5M+)</div>
            <div class="stat-value">${gold.length}</div>
            <div class="stat-change">$${(gold.reduce((s, i) => s + (i.investmentAmount || 0), 0) / 1000000).toFixed(1)}M total</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ü•à Platinum Tier ($15M+)</div>
            <div class="stat-value">${platinum.length}</div>
            <div class="stat-change">$${(platinum.reduce((s, i) => s + (i.investmentAmount || 0), 0) / 1000000).toFixed(1)}M total</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üíé Diamond Tier ($70M+)</div>
            <div class="stat-value">${diamond.length}</div>
            <div class="stat-change">$${(diamond.reduce((s, i) => s + (i.investmentAmount || 0), 0) / 1000000).toFixed(1)}M total</div>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead><tr><th>Investor</th><th>Tier</th><th>Investment</th><th>Portfolio Value</th><th>ROI</th><th>Actions</th></tr></thead>
              <tbody>
                ${items.map(u => {
                  const roi = u.investmentAmount ? (((u.portfolioValue || u.investmentAmount) - u.investmentAmount) / u.investmentAmount * 100).toFixed(1) : 0;
                  return `
                    <tr>
                      <td>
                        <div class="user-cell">
                          <div class="avatar">${(u.name || u.email)?.[0]?.toUpperCase() || '?'}</div>
                          <div>
                            <div class="user-name">${esc(u.name) || 'No name'}</div>
                            <div class="user-email">${esc(u.email)}</div>
                          </div>
                        </div>
                      </td>
                      <td><span class="badge badge-${u.investorTier}">${u.investorTier || 'N/A'}</span></td>
                      <td><strong>$${(u.investmentAmount || 0).toLocaleString()}</strong></td>
                      <td>$${(u.portfolioValue || 0).toLocaleString()}</td>
                      <td><span class="stat-change ${roi >= 0 ? 'up' : 'down'}">${roi >= 0 ? '+' : ''}${roi}%</span></td>
                      <td><button class="btn btn-primary btn-sm" onclick='openEditModal("users", "${u._id}")'>Edit</button></td>
                    </tr>
                  `;
                }).join('') || '<tr><td colspan="6" class="empty">No investors found</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // =============================================
    // RESERVATIONS
    // =============================================

    function renderReservationsPage() {
      const items = state.data.reservations || [];
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">Reservations</h1>
            <p class="page-subtitle">${items.length} total reservations</p>
          </div>
        </div>
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead><tr><th>Confirmation</th><th>Type</th><th>Guest</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody>
                ${items.map(r => `
                  <tr>
                    <td><code style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">${r.confirmationNumber || '-'}</code></td>
                    <td><span class="badge badge-info">${r.type || '-'}</span></td>
                    <td>${esc(r.user?.name || r.user?.email || 'Guest')}</td>
                    <td>${r.date ? new Date(r.date).toLocaleDateString() : '-'}</td>
                    <td><span class="badge ${r.status === 'confirmed' ? 'badge-success' : r.status === 'cancelled' ? 'badge-danger' : 'badge-warning'}">${r.status || 'pending'}</span></td>
                    <td><button class="btn btn-secondary btn-sm" onclick='openModal("viewReservation", ${JSON.stringify(r).replace(/'/g, "\\'")})'>View</button></td>
                  </tr>
                `).join('') || '<tr><td colspan="6" class="empty">No reservations</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // =============================================
    // LEADS
    // =============================================

    function renderLeadsPage() {
      const items = state.data.leads || [];
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">Leads CRM</h1>
            <p class="page-subtitle">${items.length} leads in pipeline</p>
          </div>
          <button class="btn btn-primary" onclick="openModal('addLead')">+ Add Lead</button>
        </div>
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead><tr><th>Contact</th><th>Source</th><th>Status</th><th>Score</th><th>Created</th><th>Actions</th></tr></thead>
              <tbody>
                ${items.map(l => `
                  <tr>
                    <td>
                      <div class="user-cell">
                        <div class="avatar">${(l.name || l.email)?.[0]?.toUpperCase() || '?'}</div>
                        <div>
                          <div class="user-name">${esc(l.name) || 'No name'}</div>
                          <div class="user-email">${esc(l.email) || '-'}</div>
                        </div>
                      </div>
                    </td>
                    <td>${l.source || '-'}</td>
                    <td><span class="badge badge-${l.status === 'closed' ? 'success' : l.status === 'qualified' ? 'info' : 'warning'}">${l.status || 'new'}</span></td>
                    <td>${l.score || 0}</td>
                    <td>${new Date(l.createdAt).toLocaleDateString()}</td>
                    <td>
                      <button class="btn btn-secondary btn-sm" onclick='openEditModal("leads", "${l._id}")'>Edit</button>
                    </td>
                  </tr>
                `).join('') || '<tr><td colspan="6" class="empty">No leads</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // =============================================
    // SETTINGS
    // =============================================

    function renderSettingsPage() {
      const settings = state.data.content?.find(c => c.key === 'app_settings')?.data || {};
      const contact = state.data.content?.find(c => c.key === 'contact_info')?.data || {};
      const welcome = state.data.content?.find(c => c.key === 'homepage_welcome') || {};
      
      return `
        <div class="page-header">
          <div>
            <h1 class="page-title">App Settings</h1>
            <p class="page-subtitle">Configure app branding, contact info, and content</p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><h3 class="card-title">üé® Branding</h3></div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Primary Color (Gold)</label>
                <input type="text" class="form-input" value="${settings.primaryColor || '#C9A962'}" id="s-primary">
                <div class="form-help">Main accent color used throughout the app</div>
              </div>
              <div class="form-group">
                <label class="form-label">Secondary Color (Dark)</label>
                <input type="text" class="form-input" value="${settings.secondaryColor || '#1A1A2E'}" id="s-secondary">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Logo URL</label>
              <input type="text" class="form-input" value="${settings.logoUrl || ''}" id="s-logo" placeholder="https://...">
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><h3 class="card-title">üìû Contact Information</h3></div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" value="${contact.email || ''}" id="s-email" placeholder="info@motaresort.com">
              </div>
              <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="text" class="form-input" value="${contact.phone || ''}" id="s-phone" placeholder="+1 (888) MOTA">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Address</label>
              <input type="text" class="form-input" value="${contact.address || ''}" id="s-address" placeholder="Mahogany Bay, Belize">
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><h3 class="card-title">üëã Welcome Message</h3></div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" value="${esc(welcome.title) || ''}" id="s-welcome-title" placeholder="Welcome to MOTA">
              </div>
              <div class="form-group">
                <label class="form-label">Subtitle</label>
                <input type="text" class="form-input" value="${esc(welcome.subtitle) || ''}" id="s-welcome-subtitle" placeholder="Macau of the Americas">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Body Text</label>
              <textarea class="form-textarea" id="s-welcome-body" placeholder="Welcome message...">${esc(welcome.body) || ''}</textarea>
            </div>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="saveAllSettings()">üíæ Save All Settings</button>
      `;
    }

    // =============================================
    // MODALS
    // =============================================

    function renderModal() {
      const { type, data } = state.modal;
      let content = '';
      
      if (type === 'addSlide' || type === 'editSlide') content = slideForm(data);
      else if (type === 'addRestaurant' || type === 'editRestaurant') content = restaurantForm(data);
      else if (type === 'addEvent' || type === 'editEvent') content = eventForm(data);
      else if (type === 'addProperty' || type === 'editLodging') content = lodgingForm(data);
      else if (type === 'addActivity' || type === 'editActivity') content = activityForm(data);
      else if (type === 'addVenue' || type === 'editNightlife') content = nightlifeForm(data);
      else if (type === 'editUser') content = userForm(data);
      else if (type === 'addLead' || type === 'editLead') content = leadForm(data);
      else if (type === 'viewReservation') content = reservationView(data);
      else if (type === 'sendNotification') content = notificationForm(data);
      else if (type === 'addCar' || type === 'addYacht' || type === 'editFleet') content = fleetForm(data, type);
      else content = '<div class="modal-body">Unknown modal type</div>';
      
      return `<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">${content}</div></div>`;
    }

    // Notification Form
    function notificationForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">üîî Send Notification</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleNotificationSubmit(event)">
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" name="title" class="form-input" required placeholder="Welcome to MOTA!">
            </div>
            <div class="form-group">
              <label class="form-label">Message *</label>
              <textarea name="message" class="form-textarea" required placeholder="Your message here..."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Type</label>
                <select name="type" class="form-select">
                  <option value="info">‚ÑπÔ∏è Info</option>
                  <option value="success">‚úÖ Success</option>
                  <option value="promo">üì£ Promo</option>
                  <option value="event">üéâ Event</option>
                  <option value="upgrade">‚¨ÜÔ∏è Upgrade</option>
                  <option value="system">‚öôÔ∏è System</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Target Audience</label>
                <select name="targetAudience" class="form-select">
                  <option value="all">üë• All Users</option>
                  <option value="member">üé´ Members Only</option>
                  <option value="investor">üíé Investors Only</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Target Tier (Investors Only)</label>
              <select name="targetTier" class="form-select">
                <option value="">All Tiers</option>
                <option value="gold">ü•á Gold ($2.5M+)</option>
                <option value="platinum">ü•à Platinum ($15M+)</option>
                <option value="diamond">üíé Diamond ($70M+)</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">üîî Send Notification</button>
          </div>
        </form>
      `;
    }

    // Fleet Form (Car/Yacht)
    function fleetForm(d, type) {
      const isYacht = type === 'addYacht' || (d && d.type === 'yacht');
      const isEdit = type === 'editFleet';
      
      return `
        <div class="modal-header">
          <h3 class="modal-title">${isEdit ? '‚úèÔ∏è Edit' : '‚ûï Add'} ${isYacht ? 'üõ•Ô∏è Yacht' : 'üöó Car'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleFleetSubmit(event, ${d ? `'${d._id}'` : 'null'}, '${isYacht ? 'yacht' : 'car'}')">
          <div class="modal-body">
            <input type="hidden" name="type" value="${isYacht ? 'yacht' : 'car'}">
            
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" name="name" class="form-input" value="${esc(d?.name)}" required placeholder="${isYacht ? 'Serenity' : 'Lamborghini Hurac√°n'}">
            </div>
            
            ${isYacht ? `
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Length</label>
                  <input type="text" name="length" class="form-input" value="${esc(d?.length)}" placeholder="120ft">
                </div>
                <div class="form-group">
                  <label class="form-label">Capacity (Guests)</label>
                  <input type="number" name="capacity" class="form-input" value="${d?.capacity || ''}" placeholder="40">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Cabins</label>
                  <input type="number" name="cabins" class="form-input" value="${d?.specs?.cabins || ''}" placeholder="6">
                </div>
                <div class="form-group">
                  <label class="form-label">Crew Size</label>
                  <input type="number" name="crew" class="form-input" value="${d?.specs?.crew || ''}" placeholder="8">
                </div>
              </div>
            ` : `
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Make</label>
                  <input type="text" name="make" class="form-input" value="${esc(d?.make)}" placeholder="Lamborghini">
                </div>
                <div class="form-group">
                  <label class="form-label">Model</label>
                  <input type="text" name="model" class="form-input" value="${esc(d?.model)}" placeholder="Hurac√°n EVO">
                </div>
              </div>
              <div class="form-row-3">
                <div class="form-group">
                  <label class="form-label">Year</label>
                  <input type="number" name="year" class="form-input" value="${d?.year || 2024}">
                </div>
                <div class="form-group">
                  <label class="form-label">Horsepower</label>
                  <input type="number" name="horsepower" class="form-input" value="${d?.specs?.horsepower || ''}" placeholder="640">
                </div>
                <div class="form-group">
                  <label class="form-label">0-60 mph</label>
                  <input type="text" name="acceleration" class="form-input" value="${esc(d?.specs?.acceleration)}" placeholder="2.9s">
                </div>
              </div>
            `}
            
            <div class="form-group">
              <label class="form-label">Short Description</label>
              <input type="text" name="shortDescription" class="form-input" value="${esc(d?.shortDescription)}" placeholder="Brief description for cards">
            </div>
            
            <div class="form-group">
              <label class="form-label">Full Description</label>
              <textarea name="description" class="form-textarea">${esc(d?.description)}</textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">Image URL</label>
              <input type="url" name="imageUrl" class="form-input" value="${d?.images?.[0]?.url || ''}" placeholder="https://images.unsplash.com/...">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Price Per Day ($) *</label>
                <input type="number" name="pricePerDay" class="form-input" value="${d?.pricePerDay || ''}" required placeholder="1500">
              </div>
              <div class="form-group">
                <label class="form-label">Price Per Hour ($)</label>
                <input type="number" name="pricePerHour" class="form-input" value="${d?.pricePerHour || ''}" placeholder="300">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Access Level</label>
                <select name="accessLevel" class="form-select">
                  <option value="member" ${d?.accessLevel === 'member' ? 'selected' : ''}>Members</option>
                  <option value="investor" ${d?.accessLevel === 'investor' ? 'selected' : ''}>Investors Only</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Investor Tier Required</label>
                <select name="investorTierRequired" class="form-select">
                  <option value="" ${!d?.investorTierRequired ? 'selected' : ''}>None</option>
                  <option value="gold" ${d?.investorTierRequired === 'gold' ? 'selected' : ''}>Gold</option>
                  <option value="platinum" ${d?.investorTierRequired === 'platinum' ? 'selected' : ''}>Platinum</option>
                  <option value="diamond" ${d?.investorTierRequired === 'diamond' ? 'selected' : ''}>Diamond</option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <div class="toggle ${d?.isAvailable !== false ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isAvailable">
                  <div class="toggle-switch"></div>
                  <span class="toggle-label">Available for Booking</span>
                </div>
              </div>
              <div class="form-group">
                <div class="toggle ${d?.isFeatured ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isFeatured">
                  <div class="toggle-switch"></div>
                  <span class="toggle-label">Featured</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${isEdit ? 'Update' : 'Add'} ${isYacht ? 'Yacht' : 'Car'}</button>
          </div>
        </form>
      `;
    }

    // Slide Form
    function slideForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Slide' : '‚ûï Add New Slide'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleSlideSubmit(event, ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" name="title" class="form-input" value="${esc(d?.title)}" required placeholder="Welcome to Paradise">
            </div>
            <div class="form-group">
              <label class="form-label">Subtitle</label>
              <input type="text" name="subtitle" class="form-input" value="${esc(d?.subtitle)}" placeholder="MOTA Resort & Casino">
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-textarea" placeholder="Experience the ultimate luxury...">${esc(d?.description)}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Image URL *</label>
              <input type="url" name="imageUrl" class="form-input" value="${esc(d?.imageUrl)}" required placeholder="https://images.unsplash.com/..." id="slide-img-input" oninput="previewImg(this.value, 'slide-img-preview')">
              <img id="slide-img-preview" src="${d?.imageUrl || ''}" class="img-preview" style="${d?.imageUrl ? '' : 'display:none'}" onerror="this.style.display='none'">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Button Text</label>
                <input type="text" name="buttonText" class="form-input" value="${esc(d?.buttonText)}" placeholder="Explore">
              </div>
              <div class="form-group">
                <label class="form-label">Button Link</label>
                <input type="text" name="buttonLink" class="form-input" value="${esc(d?.buttonLink)}" placeholder="/explore">
              </div>
            </div>
            <div class="form-group">
              <div class="toggle ${d?.isActive !== false ? 'active' : ''}" onclick="this.classList.toggle('active')">
                <div class="toggle-switch"></div>
                <span class="toggle-label">Active (visible on app)</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update Slide' : 'Add Slide'}</button>
          </div>
        </form>
      `;
    }

    // Restaurant Form
    function restaurantForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Restaurant' : '‚ûï Add Restaurant'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleItemSubmit(event, 'restaurants', ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-group"><label class="form-label">Name *</label><input type="text" name="name" class="form-input" value="${esc(d?.name)}" required></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Cuisine *</label><input type="text" name="cuisine" class="form-input" value="${esc(d?.cuisine)}" required placeholder="Fine Dining, Asian Fusion..."></div>
              <div class="form-group"><label class="form-label">Price Range</label>
                <select name="priceRange" class="form-select">
                  <option value="$" ${d?.priceRange === '$' ? 'selected' : ''}>$ Budget</option>
                  <option value="$$" ${d?.priceRange === '$$' ? 'selected' : ''}>$$ Moderate</option>
                  <option value="$$$" ${d?.priceRange === '$$$' ? 'selected' : ''}>$$$ Upscale</option>
                  <option value="$$$$" ${d?.priceRange === '$$$$' || !d ? 'selected' : ''}>$$$$ Fine Dining</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label class="form-label">Short Description</label><input type="text" name="shortDescription" class="form-input" value="${esc(d?.shortDescription)}" placeholder="One-line description for cards"></div>
            <div class="form-group"><label class="form-label">Full Description</label><textarea name="description" class="form-textarea">${esc(d?.description)}</textarea></div>
            <div class="form-group"><label class="form-label">Image URL</label><input type="url" name="imageUrl" class="form-input" value="${d?.images?.[0]?.url || ''}"></div>
            <div class="form-row-3">
              <div class="form-group"><label class="form-label">Rating (1-5)</label><input type="number" name="rating" class="form-input" min="1" max="5" step="0.1" value="${d?.rating || 4.5}"></div>
              <div class="form-group"><label class="form-label">Dress Code</label>
                <select name="dressCode" class="form-select">
                  <option value="casual" ${d?.dressCode === 'casual' ? 'selected' : ''}>Casual</option>
                  <option value="smart casual" ${d?.dressCode === 'smart casual' ? 'selected' : ''}>Smart Casual</option>
                  <option value="business casual" ${d?.dressCode === 'business casual' ? 'selected' : ''}>Business Casual</option>
                  <option value="formal" ${d?.dressCode === 'formal' ? 'selected' : ''}>Formal</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Reviews</label><input type="number" name="reviewCount" class="form-input" value="${d?.reviewCount || 0}"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><div class="toggle ${d?.isFeatured ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isFeatured"><div class="toggle-switch"></div><span class="toggle-label">Featured</span></div></div>
              <div class="form-group"><div class="toggle ${d?.dogFriendly ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="dogFriendly"><div class="toggle-switch"></div><span class="toggle-label">Dog Friendly</span></div></div>
              <div class="form-group"><div class="toggle ${d?.kidsFriendly ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="kidsFriendly"><div class="toggle-switch"></div><span class="toggle-label">Kids Friendly</span></div></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update' : 'Create'}</button>
          </div>
        </form>
      `;
    }

    // Event Form
    function eventForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Event' : '‚ûï Add Event'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleItemSubmit(event, 'events', ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-group"><label class="form-label">Event Name *</label><input type="text" name="name" class="form-input" value="${esc(d?.name || d?.title)}" required></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Date & Time *</label><input type="datetime-local" name="date" class="form-input" value="${d?.date ? new Date(d.date).toISOString().slice(0,16) : ''}" required></div>
              <div class="form-group"><label class="form-label">Capacity</label><input type="number" name="capacity" class="form-input" value="${d?.capacity || ''}" placeholder="Leave empty for unlimited"></div>
            </div>
            <div class="form-group"><label class="form-label">Short Description</label><input type="text" name="shortDescription" class="form-input" value="${esc(d?.shortDescription)}"></div>
            <div class="form-group"><label class="form-label">Full Description</label><textarea name="description" class="form-textarea">${esc(d?.description)}</textarea></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Venue</label><input type="text" name="venue" class="form-input" value="${esc(d?.venue)}" placeholder="Grand Ballroom"></div>
              <div class="form-group"><label class="form-label">Price ($)</label><input type="number" name="price" class="form-input" value="${d?.price || 0}"></div>
            </div>
            <div class="form-group"><label class="form-label">Image URL</label><input type="url" name="imageUrl" class="form-input" value="${d?.images?.[0]?.url || ''}"></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Access Level</label>
                <select name="accessLevel" class="form-select">
                  <option value="all" ${d?.accessLevel === 'all' ? 'selected' : ''}>All Guests</option>
                  <option value="member" ${d?.accessLevel === 'member' ? 'selected' : ''}>Members Only</option>
                  <option value="investor" ${d?.accessLevel === 'investor' ? 'selected' : ''}>Investors Only</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Category</label>
                <select name="category" class="form-select">
                  <option value="Gala" ${d?.category === 'Gala' ? 'selected' : ''}>Gala</option>
                  <option value="Dining" ${d?.category === 'Dining' ? 'selected' : ''}>Dining</option>
                  <option value="Entertainment" ${d?.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                  <option value="Investor" ${d?.category === 'Investor' ? 'selected' : ''}>Investor</option>
                  <option value="VIP" ${d?.category === 'VIP' ? 'selected' : ''}>VIP</option>
                </select>
              </div>
            </div>
            <div class="form-group"><div class="toggle ${d?.isFeatured ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isFeatured"><div class="toggle-switch"></div><span class="toggle-label">Featured Event</span></div></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update' : 'Create'}</button>
          </div>
        </form>
      `;
    }

    // Lodging Form
    function lodgingForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Property' : '‚ûï Add Property'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleItemSubmit(event, 'lodging', ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-group"><label class="form-label">Property Name *</label><input type="text" name="name" class="form-input" value="${esc(d?.name)}" required></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Type</label>
                <select name="type" class="form-select">
                  <option value="Suite" ${d?.type === 'Suite' ? 'selected' : ''}>Suite</option>
                  <option value="Villa" ${d?.type === 'Villa' ? 'selected' : ''}>Villa</option>
                  <option value="Bungalow" ${d?.type === 'Bungalow' ? 'selected' : ''}>Bungalow</option>
                  <option value="Penthouse" ${d?.type === 'Penthouse' ? 'selected' : ''}>Penthouse</option>
                  <option value="Cottage" ${d?.type === 'Cottage' ? 'selected' : ''}>Cottage</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Price/Night ($) *</label><input type="number" name="price" class="form-input" value="${d?.price || d?.pricePerNight || ''}" required></div>
            </div>
            <div class="form-group"><label class="form-label">Short Description</label><input type="text" name="shortDescription" class="form-input" value="${esc(d?.shortDescription)}"></div>
            <div class="form-group"><label class="form-label">Full Description</label><textarea name="description" class="form-textarea">${esc(d?.description)}</textarea></div>
            <div class="form-row-3">
              <div class="form-group"><label class="form-label">Bedrooms</label><input type="number" name="bedrooms" class="form-input" value="${d?.bedrooms || 1}"></div>
              <div class="form-group"><label class="form-label">Bathrooms</label><input type="number" name="bathrooms" class="form-input" value="${d?.bathrooms || 1}"></div>
              <div class="form-group"><label class="form-label">Max Guests</label><input type="number" name="maxGuests" class="form-input" value="${d?.maxGuests || 2}"></div>
            </div>
            <div class="form-group"><label class="form-label">Image URL</label><input type="url" name="imageUrl" class="form-input" value="${d?.images?.[0]?.url || ''}"></div>
            <div class="form-row">
              <div class="form-group"><div class="toggle ${d?.isAvailable !== false ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isAvailable"><div class="toggle-switch"></div><span class="toggle-label">Available for Booking</span></div></div>
              <div class="form-group"><div class="toggle ${d?.isFeatured ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isFeatured"><div class="toggle-switch"></div><span class="toggle-label">Featured Property</span></div></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update' : 'Create'}</button>
          </div>
        </form>
      `;
    }

    // Activity Form
    function activityForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Activity' : '‚ûï Add Activity'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleItemSubmit(event, 'activities', ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-group"><label class="form-label">Activity Name *</label><input type="text" name="name" class="form-input" value="${esc(d?.name)}" required></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Category</label>
                <select name="category" class="form-select">
                  <option value="Water Sports" ${d?.category === 'Water Sports' ? 'selected' : ''}>Water Sports</option>
                  <option value="Adventure" ${d?.category === 'Adventure' ? 'selected' : ''}>Adventure</option>
                  <option value="Cultural" ${d?.category === 'Cultural' ? 'selected' : ''}>Cultural</option>
                  <option value="Wellness" ${d?.category === 'Wellness' ? 'selected' : ''}>Wellness</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Price ($) *</label><input type="number" name="price" class="form-input" value="${d?.price || ''}" required></div>
            </div>
            <div class="form-group"><label class="form-label">Short Description</label><input type="text" name="shortDescription" class="form-input" value="${esc(d?.shortDescription)}"></div>
            <div class="form-group"><label class="form-label">Full Description</label><textarea name="description" class="form-textarea">${esc(d?.description)}</textarea></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Duration</label><input type="text" name="duration" class="form-input" value="${esc(d?.duration)}" placeholder="3 hours, Full Day..."></div>
              <div class="form-group"><label class="form-label">Skill Level</label>
                <select name="skillLevel" class="form-select">
                  <option value="all levels" ${d?.skillLevel === 'all levels' ? 'selected' : ''}>All Levels</option>
                  <option value="beginner" ${d?.skillLevel === 'beginner' ? 'selected' : ''}>Beginner</option>
                  <option value="intermediate" ${d?.skillLevel === 'intermediate' ? 'selected' : ''}>Intermediate</option>
                  <option value="advanced" ${d?.skillLevel === 'advanced' ? 'selected' : ''}>Advanced</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label class="form-label">Image URL</label><input type="url" name="imageUrl" class="form-input" value="${d?.images?.[0]?.url || ''}"></div>
            <div class="form-group"><div class="toggle ${d?.isFeatured ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isFeatured"><div class="toggle-switch"></div><span class="toggle-label">Featured Activity</span></div></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update' : 'Create'}</button>
          </div>
        </form>
      `;
    }

    // Nightlife Form
    function nightlifeForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Venue' : '‚ûï Add Venue'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleItemSubmit(event, 'nightlife', ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-group"><label class="form-label">Venue Name *</label><input type="text" name="name" class="form-input" value="${esc(d?.name)}" required></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Type</label>
                <select name="type" class="form-select">
                  <option value="Rooftop Bar" ${d?.type === 'Rooftop Bar' ? 'selected' : ''}>Rooftop Bar</option>
                  <option value="Nightclub" ${d?.type === 'Nightclub' ? 'selected' : ''}>Nightclub</option>
                  <option value="Lounge" ${d?.type === 'Lounge' ? 'selected' : ''}>Lounge</option>
                  <option value="Beach Bar" ${d?.type === 'Beach Bar' ? 'selected' : ''}>Beach Bar</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Price Range</label>
                <select name="priceRange" class="form-select">
                  <option value="$$" ${d?.priceRange === '$$' ? 'selected' : ''}>$$</option>
                  <option value="$$$" ${d?.priceRange === '$$$' ? 'selected' : ''}>$$$</option>
                  <option value="$$$$" ${d?.priceRange === '$$$$' ? 'selected' : ''}>$$$$</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label class="form-label">Description</label><textarea name="description" class="form-textarea">${esc(d?.description)}</textarea></div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Hours</label><input type="text" name="hours" class="form-input" value="${esc(d?.hours)}" placeholder="5:00 PM - 1:00 AM"></div>
              <div class="form-group"><label class="form-label">Music Type</label><input type="text" name="musicType" class="form-input" value="${esc(d?.musicType)}" placeholder="EDM, Jazz, Lounge..."></div>
            </div>
            <div class="form-group"><label class="form-label">Image URL</label><input type="url" name="imageUrl" class="form-input" value="${d?.images?.[0]?.url || ''}"></div>
            <div class="form-group"><div class="toggle ${d?.isFeatured ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isFeatured"><div class="toggle-switch"></div><span class="toggle-label">Featured Venue</span></div></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update' : 'Create'}</button>
          </div>
        </form>
      `;
    }

    // USER FORM - FULL EDITING
    function userForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Edit User</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleUserSubmit(event, '${d?._id}')">
          <div class="modal-body">
            <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border);">
              <div class="avatar avatar-lg">${(d?.name || d?.email)?.[0]?.toUpperCase() || '?'}</div>
              <div>
                <h3 style="margin-bottom:4px;">${esc(d?.name) || 'No name'}</h3>
                <p style="color:var(--text-secondary);margin:0;">${esc(d?.email)}</p>
                <p style="color:var(--text-muted);margin:4px 0 0;font-size:12px;">Joined ${new Date(d?.createdAt).toLocaleDateString()}</p>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" class="form-input" value="${esc(d?.name)}">
              </div>
              <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" name="phone" class="form-input" value="${esc(d?.phone)}" placeholder="+1 (555) 000-0000">
              </div>
            </div>
            
            <div class="divider"></div>
            <h4 style="margin-bottom:16px;color:var(--text-secondary);">Access & Permissions</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Access Level</label>
                <select name="accessLevel" class="form-select">
                  <option value="guest" ${d?.accessLevel === 'guest' ? 'selected' : ''}>Guest</option>
                  <option value="member" ${d?.accessLevel === 'member' ? 'selected' : ''}>Member</option>
                  <option value="investor" ${d?.accessLevel === 'investor' ? 'selected' : ''}>Investor</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Investor Tier</label>
                <select name="investorTier" class="form-select">
                  <option value="" ${!d?.investorTier ? 'selected' : ''}>None</option>
                  <option value="gold" ${d?.investorTier === 'gold' ? 'selected' : ''}>ü•á Gold ($2.5M+)</option>
                  <option value="platinum" ${d?.investorTier === 'platinum' ? 'selected' : ''}>ü•à Platinum ($15M+)</option>
                  <option value="diamond" ${d?.investorTier === 'diamond' ? 'selected' : ''}>üíé Diamond ($70M+)</option>
                </select>
              </div>
            </div>
            
            <div class="divider"></div>
            <h4 style="margin-bottom:16px;color:var(--text-secondary);">Investment Details</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Investment Amount ($)</label>
                <input type="number" name="investmentAmount" class="form-input" value="${d?.investmentAmount || 0}">
              </div>
              <div class="form-group">
                <label class="form-label">Portfolio Value ($)</label>
                <input type="number" name="portfolioValue" class="form-input" value="${d?.portfolioValue || 0}">
              </div>
            </div>
            
            <div class="form-group">
              <div class="toggle ${d?.isActive !== false ? 'active' : ''}" onclick="this.classList.toggle('active')" data-field="isActive">
                <div class="toggle-switch"></div>
                <span class="toggle-label">Account Active</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      `;
    }

    // Lead Form
    function leadForm(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">${d ? '‚úèÔ∏è Edit Lead' : '‚ûï Add Lead'}</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form onsubmit="handleItemSubmit(event, 'leads', ${d ? `'${d._id}'` : 'null'})">
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group"><label class="form-label">Name *</label><input type="text" name="name" class="form-input" value="${esc(d?.name)}" required></div>
              <div class="form-group"><label class="form-label">Email *</label><input type="email" name="email" class="form-input" value="${esc(d?.email)}" required></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Phone</label><input type="tel" name="phone" class="form-input" value="${esc(d?.phone)}"></div>
              <div class="form-group"><label class="form-label">Source</label>
                <select name="source" class="form-select">
                  <option value="website" ${d?.source === 'website' ? 'selected' : ''}>Website</option>
                  <option value="referral" ${d?.source === 'referral' ? 'selected' : ''}>Referral</option>
                  <option value="event" ${d?.source === 'event' ? 'selected' : ''}>Event</option>
                  <option value="social" ${d?.source === 'social' ? 'selected' : ''}>Social Media</option>
                  <option value="advertising" ${d?.source === 'advertising' ? 'selected' : ''}>Advertising</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Status</label>
                <select name="status" class="form-select">
                  <option value="new" ${d?.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="contacted" ${d?.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                  <option value="qualified" ${d?.status === 'qualified' ? 'selected' : ''}>Qualified</option>
                  <option value="proposal" ${d?.status === 'proposal' ? 'selected' : ''}>Proposal Sent</option>
                  <option value="negotiation" ${d?.status === 'negotiation' ? 'selected' : ''}>Negotiation</option>
                  <option value="closed" ${d?.status === 'closed' ? 'selected' : ''}>Closed Won</option>
                  <option value="lost" ${d?.status === 'lost' ? 'selected' : ''}>Closed Lost</option>
                </select>
              </div>
              <div class="form-group"><label class="form-label">Lead Score (0-100)</label><input type="number" name="score" class="form-input" min="0" max="100" value="${d?.score || 0}"></div>
            </div>
            <div class="form-group"><label class="form-label">Notes</label><textarea name="notes" class="form-textarea">${esc(d?.notes)}</textarea></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">${d ? 'Update' : 'Create'}</button>
          </div>
        </form>
      `;
    }

    // Reservation View
    function reservationView(d) {
      return `
        <div class="modal-header">
          <h3 class="modal-title">üìÖ Reservation Details</h3>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div style="display:grid;gap:16px;">
            <div style="display:flex;justify-content:space-between;padding:12px 16px;background:var(--bg-secondary);border-radius:8px;">
              <span style="color:var(--text-secondary);">Confirmation #</span>
              <code style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">${d?.confirmationNumber || '-'}</code>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px 16px;background:var(--bg-secondary);border-radius:8px;">
              <span style="color:var(--text-secondary);">Type</span>
              <span class="badge badge-info">${d?.type || '-'}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px 16px;background:var(--bg-secondary);border-radius:8px;">
              <span style="color:var(--text-secondary);">Status</span>
              <span class="badge ${d?.status === 'confirmed' ? 'badge-success' : 'badge-warning'}">${d?.status || 'pending'}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px 16px;background:var(--bg-secondary);border-radius:8px;">
              <span style="color:var(--text-secondary);">Guest</span>
              <span>${esc(d?.user?.name || d?.user?.email || 'Guest')}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:12px 16px;background:var(--bg-secondary);border-radius:8px;">
              <span style="color:var(--text-secondary);">Date</span>
              <span>${d?.date ? new Date(d.date).toLocaleString() : '-'}</span>
            </div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>
      `;
    }

    // =============================================
    // FORM HANDLERS
    // =============================================

    function getFormData(form) {
      const data = {};
      new FormData(form).forEach((v, k) => {
        if (v === '') return;
        if (!isNaN(v) && v !== '') v = Number(v);
        data[k] = v;
      });
      form.querySelectorAll('.toggle').forEach(t => {
        const field = t.dataset.field;
        if (field) data[field] = t.classList.contains('active');
      });
      if (data.imageUrl) {
        data.images = [{ url: data.imageUrl, isPrimary: true }];
        delete data.imageUrl;
      }
      return data;
    }

    window.handleSlideSubmit = async function(e, id) {
      e.preventDefault();
      const data = getFormData(e.target);
      data.isActive = e.target.querySelector('.toggle')?.classList.contains('active') ?? true;
      
      const slideshow = state.data.content?.find(c => c.key === 'homepage_slideshow') || { slides: [] };
      let slides = [...(slideshow.slides || [])];
      
      if (id) {
        slides = slides.map(s => s._id === id ? { ...s, ...data } : s);
      } else {
        slides.push({ ...data, order: slides.length });
      }
      
      await saveContent('homepage_slideshow', { slides });
    };

    window.editSlide = function(index) {
      const slideshow = state.data.content?.find(c => c.key === 'homepage_slideshow');
      const slide = slideshow?.slides?.[index];
      if (slide) openModal('editSlide', slide);
    };

    window.deleteSlide = async function(id, title) {
      if (!confirm(`Delete slide "${title || 'this slide'}"?`)) return;
      const slideshow = state.data.content?.find(c => c.key === 'homepage_slideshow');
      const slides = (slideshow?.slides || []).filter(s => s._id !== id);
      await saveContent('homepage_slideshow', { slides });
    };

    window.handleItemSubmit = async function(e, type, id) {
      e.preventDefault();
      await saveItem(type, id, getFormData(e.target));
    };

    window.handleUserSubmit = async function(e, id) {
      e.preventDefault();
      const data = getFormData(e.target);
      data.isActive = e.target.querySelector('.toggle[data-field="isActive"]')?.classList.contains('active') ?? true;
      await saveItem('users', id, data);
    };

    window.openEditModal = function(type, id) {
      const item = state.data[type]?.find(i => i._id === id);
      if (!item) return alert('Item not found');
      
      const modalMap = {
        restaurants: 'editRestaurant',
        events: 'editEvent',
        lodging: 'editLodging',
        activities: 'editActivity',
        nightlife: 'editNightlife',
        users: 'editUser',
        leads: 'editLead',
        fleet: 'editFleet'
      };
      openModal(modalMap[type], item);
    };

    window.saveAllSettings = async function() {
      const settings = {
        primaryColor: document.getElementById('s-primary').value,
        secondaryColor: document.getElementById('s-secondary').value,
        logoUrl: document.getElementById('s-logo').value
      };
      const contact = {
        email: document.getElementById('s-email').value,
        phone: document.getElementById('s-phone').value,
        address: document.getElementById('s-address').value
      };
      const welcome = {
        title: document.getElementById('s-welcome-title').value,
        subtitle: document.getElementById('s-welcome-subtitle').value,
        body: document.getElementById('s-welcome-body').value
      };
      
      try {
        await Promise.all([
          api('/content/app_settings', { method: 'PUT', body: JSON.stringify({ data: settings }) }),
          api('/content/contact_info', { method: 'PUT', body: JSON.stringify({ data: contact }) }),
          api('/content/homepage_welcome', { method: 'PUT', body: JSON.stringify(welcome) })
        ]);
        showAlert('All settings saved successfully!', 'success');
        loadData();
      } catch (err) {
        alert('Error saving: ' + err.message);
      }
    };

    window.previewImg = function(url, id) {
      const img = document.getElementById(id);
      if (img) {
        img.src = url;
        img.style.display = url ? 'block' : 'none';
      }
    };

    // Notification Handler
    window.handleNotificationSubmit = async function(e) {
      e.preventDefault();
      const formData = getFormData(e.target);
      
      // Map form data to backend expected format
      let targetType = formData.targetAudience || 'all';
      
      // If targeting investors and a specific tier is selected, use the tier as targetType
      if (formData.targetAudience === 'investor' && formData.targetTier) {
        targetType = formData.targetTier; // 'gold', 'platinum', or 'diamond'
      } else if (formData.targetAudience === 'investor') {
        targetType = 'investors'; // All investors
      } else if (formData.targetAudience === 'member') {
        targetType = 'members';
      }
      
      const data = {
        title: formData.title,
        message: formData.message,
        type: formData.type || 'info',
        targetType: targetType
      };
      
      try {
        const result = await api('/notifications/send', { method: 'POST', body: JSON.stringify(data) });
        showAlert(`Notification sent to ${result.targetCount || 'all'} users!`, 'success');
        closeModal();
        loadData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    // Quick Notification Templates
    window.quickNotification = function(type) {
      const templates = {
        promo: { title: 'üéÅ Special Offer!', message: 'Exclusive deals await you at MOTA Resort. Check out our latest promotions!', type: 'promo', targetAudience: 'all', targetTier: '' },
        event: { title: 'üéâ Event Reminder', message: 'Don\'t miss our upcoming event! RSVP now to secure your spot.', type: 'event', targetAudience: 'all', targetTier: '' },
        investor: { title: 'üíé Investor Update', message: 'Your quarterly portfolio report is now available. Log in to view your returns.', type: 'upgrade', targetAudience: 'investor', targetTier: '' },
        system: { title: '‚öôÔ∏è System Update', message: 'We\'ve made improvements to enhance your experience. Enjoy the new features!', type: 'system', targetAudience: 'all', targetTier: '' },
        gold: { title: 'ü•á Gold Member Exclusive', message: 'As a valued Gold investor, you have access to exclusive benefits.', type: 'upgrade', targetAudience: 'investor', targetTier: 'gold' },
        platinum: { title: 'ü•à Platinum Privileges', message: 'Your Platinum status unlocks premium experiences. View your benefits.', type: 'upgrade', targetAudience: 'investor', targetTier: 'platinum' },
        diamond: { title: 'üíé Diamond Elite Access', message: 'Welcome to the pinnacle of MOTA luxury. Your Diamond concierge awaits.', type: 'upgrade', targetAudience: 'investor', targetTier: 'diamond' }
      };
      
      state.modal = { type: 'sendNotification', data: templates[type] };
      render();
      
      // Pre-fill form after render
      setTimeout(() => {
        const t = templates[type];
        const form = document.querySelector('form');
        if (form) {
          form.querySelector('[name="title"]').value = t.title;
          form.querySelector('[name="message"]').value = t.message;
          form.querySelector('[name="type"]').value = t.type;
          form.querySelector('[name="targetAudience"]').value = t.targetAudience;
          form.querySelector('[name="targetTier"]').value = t.targetTier || '';
        }
      }, 50);
    };

    // Fleet Handler
    window.handleFleetSubmit = async function(e, id, fleetType) {
      e.preventDefault();
      const formData = getFormData(e.target);
      
      // Build specs object based on type
      const specs = {};
      if (fleetType === 'car') {
        if (formData.horsepower) specs.horsepower = formData.horsepower;
        if (formData.acceleration) specs.acceleration = formData.acceleration;
        delete formData.horsepower;
        delete formData.acceleration;
      } else {
        if (formData.cabins) specs.cabins = formData.cabins;
        if (formData.crew) specs.crew = formData.crew;
        delete formData.cabins;
        delete formData.crew;
      }
      
      if (Object.keys(specs).length > 0) {
        formData.specs = specs;
      }
      
      formData.type = fleetType;
      
      try {
        if (id) {
          await api(`/fleet/${id}`, { method: 'PUT', body: JSON.stringify(formData) });
          showAlert('Fleet item updated!', 'success');
        } else {
          await api('/fleet', { method: 'POST', body: JSON.stringify(formData) });
          showAlert('Fleet item added!', 'success');
        }
        closeModal();
        loadData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    // =============================================
    // EVENTS
    // =============================================

    function attachEvents() {
      document.getElementById('login-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const err = await login(
          document.getElementById('login-email').value,
          document.getElementById('login-password').value
        );
        if (err) {
          const el = document.getElementById('login-error');
          el.textContent = err;
          el.classList.remove('hidden');
        }
      });

      document.querySelectorAll('.nav-item[data-page]').forEach(el => {
        el.addEventListener('click', () => navigate(el.dataset.page));
      });

      document.getElementById('logout-btn')?.addEventListener('click', logout);
    }

    // =============================================
    // INIT
    // =============================================

    checkAuth();
    render();
    if (state.isLoggedIn) loadData();
  </script>
</body>
</html>
